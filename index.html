<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="tournamentName">Turniej Tenisa Stoowego</title>
<!-- PWA Meta Tags -->
<meta name="application-name" content="Turniej TT">
<meta name="apple-mobile-web-app-title" content="Turniej TT">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#1e5799">

<!-- Manifest -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1e5799">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<link rel="apple-touch-icon" href="icons/icon-512x512.png">

    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e5799 0%, #2989d8 50%, #207cca 51%, #7db9e8 100%);
            padding: 20px;
            color: #333;
            margin: 0;
            position: relative;
            min-height: 100vh;
        }
        
        body::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            pointer-events: none;
            z-index: -1;
        }

*, *::before, *::after {
    box-sizing: border-box;
}

        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

      h1 {
    color: #fff;
    text-align: center;
    margin-bottom: 30px;
    font-size: 2.2rem;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    background: rgba(0, 0, 0, 0.2);
    padding: 15px;
    border-radius: 10px;
    border: 2px solid rgba(255,255,255,0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    position: relative;
    margin-top: 70px;
    min-height: 80px;
    box-sizing: border-box;
}

h1::before,
h1::after {
    content: "";
    font-size: 2rem;
}

.language-switcher {
    position: absolute;
    top: 20px;
    right: 20px;
    display: flex;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #3498db;
    width: fit-content;
    z-index: 1000;
    background: white;
}

.lang-btn {
    background: #e3f2fd;
    border: none;
    padding: 10px 16px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
    flex: 1;
    color: #2c3e50;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 5px;
    min-width: 60px;
    justify-content: center;
}

.lang-btn:hover {
    background: #bbdefb;
    color: #2c3e50;
}

.lang-btn.active {
    background: #3498db;
    color: white;
}

.flag {
    font-size: 16px;
}

        .control-panel, .main-group-section, .knockout-container, .consolation-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-bottom: 30px;
            position: relative;
            border: 1px solid rgba(0,0,0,0.1);
        }

        #classification-place-1 {
            background: linear-gradient(135deg, #FFD700, #FFEC8B) !important;
            border: 2px solid #D4AF37 !important;
            font-weight: bold;
        }

        #classification-place-2 {
            background: linear-gradient(135deg, #C0C0C0, #E8E8E8) !important;
            border: 2px solid #A8A8A8 !important;
            font-weight: bold;
        }

        #classification-place-3 {
            background: linear-gradient(135deg, #CD7F32, #E9B384) !important;
            border: 2px solid #8B4513 !important;
            font-weight: bold;
        }

        .input-group {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            min-height: 150px;
            font-size: 1rem;
        }

        label {
            font-weight: 600;
            color: #2c3e50;
            min-width: 120px;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background 0.3s;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:hover {
            background: #2980b9;
        }

        select, input[type="number"] {
            padding: 8px;
            font-size: 1rem;
            border-radius: 6px;
            border: 1px solid #bbb;
        }

        .table-container {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            max-width: 100%;
            table-layout: auto;
            border-collapse: collapse;
            margin-bottom: 15px;
            border-radius: 8px;
            overflow: hidden;
        }

        th {
            background: #003366;
            color: #fff;
            font-weight: 600;
        }

        tr:nth-child(even) {
            background-color: #f5f7fa;
        }

        tr:nth-child(odd) {
            background-color: #ffffff;
        }

        td, th {
            padding: 4px 2px;
            text-align: center;
            border: 1px solid #b6c4d7;
            vertical-align: middle;
            height: 48px;
            line-height: 1.3;
            box-sizing: border-box;
            font-size: 0.9rem;
            min-height: 44px;
        }

        .player-header {
            background: #3498db;
            color: white;
            font-weight: bold;
            white-space: normal;
            min-width: 80px;
            vertical-align: top;
        }

        th:nth-child(n+2) {
            white-space: normal;
            min-width: 60px;
        }

        .summary-punkty {
            width: 60px !important;
            min-width: 60px !important;
            max-width: 60px !important;
            white-space: nowrap;
        }

        .summary-bilans {
            width: 90px !important;
            min-width: 90px !important;
            max-width: 90px !important;
            white-space: nowrap;
        }

        .summary-miejsce {
            width: 60px !important;
            min-width: 60px !important;
            max-width: 60px !important;
            white-space: nowrap;
        }

        input[type="text"] {
            padding: 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-align: center;
            box-sizing: border-box;
            line-height: 1.3;
            font-size: 16px;
        }

        .score-input {
            width: 40px;
            padding: 5px;
            min-height: 44px;
            font-size: 16px;
        }

        .category-input,#tournamentNameInput {
            width: 250px;
            text-align: left !important;
            font-size: 1rem;
            padding: 8px;
            border-radius: 6px;
            flex-grow: 1;
            font-size: 16px;
        }

        .summary-header {
            background: #27ae60;
            color: white;
            white-space: nowrap;
        }

        .qualified {
            background-color: #d4edda !important;
            font-weight: bold;
        }

        .bold-x {
            font-weight: bold;
        }

        .group-container {
            margin-bottom: 20px;
        }

        .group-title {
            font-size: 1.5rem;
            color: #2c3e50;
            margin: 20px 0 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .manual-group {
            margin-bottom: 20px;
        }

        .manual-group label {
            font-weight: bold;
        }

        .manual-group textarea {
            min-height: 60px;
            font-size: 16px;
        }

        #manual-groups {
            margin-top: 15px;
        }

        #settingsHeader::before {
            content: "锔 ";
        }

        #settingsHeader::after {
            content: " 锔";
        }

        .knockout-header {
            font-size: 1.8rem;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            text-align: center;
        }

        .bracket {
            display: flex;
            justify-content: flex-start;
            column-gap: 60px;
            overflow-x: auto;
        }

        .bracket-column {
            display: flex;
            flex-direction: column;
            justify-content: space-around;
            min-width: 330px;
        }

        .round-title {
            text-align: center;
            font-weight: 700;
            color: #000;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .bracket-match {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            min-width: 180px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }

        .bracket-player {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 6px 0;
            padding: 6px;
            border-radius: 3px;
            font-size: 0.9rem;
        }

        .player-name {
            background: #e9ecef;
            border-radius: 3px;
            padding: 6px 10px;
            min-width: 100px;
            font-weight: 500;
            flex-grow: 1;
            white-space: normal;
        }

        .score-input {
            width: 40px;
            padding: 5px;
            border: 1px solid #bbb;
            border-radius: 3px;
            text-align: center;
            font-size: 16px;
        }

        .player-color-1 { background-color: #e3f2fd; border-left: 5px solid #1e88e5; }
        .player-color-2 { background-color: #ffebee; border-left: 5px solid #e53935; }
        .player-color-3 { background-color: #e8f5e9; border-left: 5px solid #43a047; }
        .player-color-4 { background-color: #fff8e1; border-left: 5px solid #ffb300; }
        .player-color-5 { background-color: #f3e5f5; border-left: 5px solid #8e24aa; }
        .player-color-6 { background-color: #e0f7fa; border-left: 5px solid #00bcd4; }
        .player-color-7 { background-color: #fff3e0; border-left: 5px solid #fb8c00; }
        .player-color-8 { background-color: #e8eaf6; border-left: 5px solid #3f51b5; }

        .third-place-match {
            border: 2px solid #e74c3c;
            background: #fff0f0;
            margin-top: 15px;
            padding: 8px;
        }

        .final-match {
            border: 2px solid #2980b9;
            background: #f0f8ff;
            margin-top: 15px;
            padding: 8px;
        }

        .group-buttons-container {
            margin-top: 20px;
            margin-bottom: 20px;
            text-align: left;
            width: 100%;
        }

        .group-buttons-container button {
            margin: 0 10px 10px 0;
        }

        .control-buttons-row {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 20px;
        }

        .clear-data-button {
            background: #e74c3c;
        }

        .clear-data-button:hover {
            background: #c0392b;
        }

        .collapse-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #555;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            z-index: 10;
            transition: background 0.3s ease;
            white-space: nowrap;
            max-width: 80px;
        }

        .collapse-button:hover {
            background: #777;
        }

        .collapsible-content {
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            padding-top: 10px;
        }

        .collapsed .collapsible-content {
            max-height: 0;
            padding-top: 0;
        }

        .collapsed .knockout-header {
            margin-bottom: 25;
        }

        .classification-box {
            border-radius: 6px;
            padding: 8px 12px;
            margin: 8px 0;
            min-width: 180px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .classification-place {
            font-weight: bold;
            font-size: 1em;
            width: 28px;
            text-align: right;
            color: #2c3e50;
        }

        .group-view-toggle {
            display: flex;
            margin-bottom: 15px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #3498db;
            width: fit-content;
        }

        .view-toggle-btn {
            background: #e3f2fd;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            flex: 1;
            color: #2c3e50;
        }

        .view-toggle-btn.active {
            background: #3498db;
            color: white;
        }

        .view-toggle-btn:not(.active):hover {
            background: #bbdefb;
            color: #2c3e50;
        }

        .schedule-container {
            display: none;
        }

        .schedule-container.active {
            display: block;
        }

        .match-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-bottom: 1px solid #eee;
            background: white;
            transition: background 0.2s;
        }

        .match-item:hover {
            background: #f8f9fa;
        }

        .match-item:nth-child(even) {
            background: #f8f9fa;
        }

        .match-item:nth-child(even):hover {
            background: #e9ecef;
        }

        .match-players {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .match-player {
            flex: 1;
            padding: 5px 10px;
            border-radius: 4px;
            background: #e9ecef;
        }

        .match-player.vs {
            flex: 0;
            font-weight: bold;
            background: transparent;
        }

        .match-result {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .match-result-input {
            width: 50px;
            padding: 5px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .match-status {
            margin-left: 10px;
            font-size: 0.8rem;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        .match-status.played {
            background: #d4edda;
            color: #155724;
        }

        .match-status.pending {
            background: #fff3cd;
            color: #856404;
        }

        /* STYLE DLA MECZU "TRWA" */
        .match-in-progress {
            background-color: #fff9e6 !important;
            border-left: 4px solid #f39c12 !important;
            box-shadow: 0 0 8px rgba(243, 156, 18, 0.3);
        }

        .match-inprogress-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            margin-right: 5px;
        }

        .in-progress-label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            font-weight: 500;
            color: #e67e22;
            margin-left: 10px;
            white-space: nowrap;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
/* ========== STYLE DLA HARMONOGRAMU ========== */

/* MECZ ROZEGRANY - zielone podwietlenie */
.match-item.match-played {
    background-color: #f8fff9 !important;
    border-left: 4px solid #27ae60 !important;
    position: relative;
    transition: all 0.3s ease;
}

/* Delikatny gradient dla lepszego efektu */
.match-item.match-played:nth-child(odd) {
    background: linear-gradient(90deg, #f8fff9 0%, #e8f8e8 100%) !important;
}

.match-item.match-played:nth-child(even) {
    background: linear-gradient(90deg, #e8f5e9 0%, #d8eed8 100%) !important;
}

/* Status "Rozegrany" - bardziej widoczny */
.match-status.played {
    background: #27ae60 !important;
    color: white !important;
    font-weight: 600;
    box-shadow: 0 2px 4px rgba(39, 174, 96, 0.3);
}

/* MECZ W TRAKCIE - 偶贸te podwietlenie (ju偶 jest) */
.match-in-progress {
    background-color: #fff9e6 !important;
    border-left: 4px solid #f39c12 !important;
    box-shadow: 0 0 8px rgba(243, 156, 18, 0.3);
}

/* Dla lepszego kontrastu na mobile */
@media (max-width: 767px) {
    .match-item.match-played {
        border-left-width: 3px;
    }
    
    .match-item.match-played::after {
        font-size: 10px;
        left: 5px;
    }
}
       @media (max-width: 767px) {
    .container {
        padding: 10px;
    }

    h1 {
        font-size: 1.5rem;
        margin-bottom: 20px;
        gap: 10px;
        margin-top: 60px;
        padding: 12px 15px;
        min-height: 70px;
    }

    h1::before,
    h1::after {
        font-size: 1.3rem;
    }

    .language-switcher {
        top: 10px;
        right: 10px;
    }

    .lang-btn {
        padding: 6px 10px;
        font-size: 12px;
    }

            .knockout-header {
                font-size: 1.3rem;
                margin-bottom: 15px;
            }

            .input-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .input-group label {
                min-width: auto;
                font-size: 0.9rem;
            }

            textarea, input[type="text"], select, input[type="number"] {
                width: 100%;
                font-size: 16px;
            }

            .category-input, #tournamentNameInput {
                width: 100%;
            }

            button {
                width: 100%;
                margin: 5px 0;
                padding: 14px 20px;
                font-size: 1rem;
            }

            .group-buttons-container button {
                width: auto;
                min-width: 120px;
            }

            .control-buttons-row {
                flex-direction: column;
                gap: 10px;
            }

            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                font-size: 0.8rem;
                min-width: 600px;
            }

            td, th {
                padding: 3px 1px;
                height: 40px;
                font-size: 0.75rem;
            }

            .player-header {
                min-width: 60px;
                font-size: 0.7rem;
            }

            .summary-punkty, .summary-miejsce {
                width: 50px !important;
                min-width: 50px !important;
            }

            .summary-bilans {
                width: 70px !important;
                min-width: 70px !important;
            }

            .bracket {
                flex-direction: column;
                gap: 20px;
            }

            .bracket-column {
                min-width: 100%;
                gap: 15px;
            }

            .bracket-match {
                min-width: 100%;
                margin: 5px 0;
            }

            .round-title {
                font-size: 1rem;
                margin-bottom: 5px;
            }

            .bracket-player {
                font-size: 0.8rem;
            }

            .player-name {
                min-width: 80px;
                font-size: 0.8rem;
            }

            .score-input {
                width: 35px;
                padding: 4px;
            }

            .classification-box {
                min-width: 100%;
                font-size: 0.8rem;
            }

            .manual-group {
                margin-bottom: 15px;
            }

            .manual-group textarea {
                min-height: 80px;
            }

            .collapse-button {
                padding: 6px 10px;
                font-size: 0.7rem;
                max-width: 70px;
                top: 8px;
                right: 8px;
            }

            .group-title {
                font-size: 1.2rem;
                margin: 15px 0 10px;
            }

            .control-panel, .main-group-section, .knockout-container, .consolation-container {
                padding: 15px;
                margin-top: 20px;
                margin-bottom: 20px;
            }

            .match-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .match-players {
                width: 100%;
            }

            .match-result {
                width: 100%;
                justify-content: flex-end;
            }

            .view-toggle-btn {
                padding: 8px 12px;
                font-size: 0.9rem;
            }
            
            /* Dla responsywnoci "Trwa" */
            .in-progress-label {
                font-size: 0.8rem;
                margin-left: 5px;
            }
            
            .match-inprogress-checkbox {
                width: 16px;
                height: 16px;
            }
        }

        @media (max-width: 479px) {
            .container {
                padding: 5px;
            }

            h1 {
                font-size: 1.3rem;
            }

            h1::before,
            h1::after {
                font-size: 1.1rem;
            }

            .language-switcher {
                top: 5px;
                right: 5px;
            }

            .lang-btn {
                padding: 5px 8px;
                font-size: 11px;
            }

            .knockout-header {
                font-size: 1.1rem;
            }

            button {
                padding: 12px 16px;
                font-size: 0.9rem;
            }

            .group-buttons-container {
                text-align: center;
            }

            .group-buttons-container button {
                width: 100%;
                margin: 2px 0;
            }

            table {
                min-width: 500px;
                font-size: 0.7rem;
            }

            .bracket-player {
                flex-direction: column;
                gap: 4px;
            }

            .player-name {
                min-width: 100%;
                text-align: center;
            }

            .collapse-button {
                padding: 5px 8px;
                font-size: 0.65rem;
                max-width: 60px;
                top: 5px;
                right: 5px;
            }
        }

        @media (max-width: 767px) and (orientation: landscape) {
            .bracket {
                flex-direction: row;
                overflow-x: auto;
            }

            .bracket-column {
                min-width: 280px;
            }

            .table-container {
                max-height: 300px;
                overflow-y: auto;
            }
        }

        @media (max-width: 767px) and (min-height: 1000px) {
            .container {
                padding: 20px 10px;
            }

           .control-panel, .main-group-section, .knockout-container, .consolation-container {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    margin-bottom: 30px;
    position: relative;
    border: 1px solid rgba(0,0,0,0.1);
}
        }

        @media (max-width: 767px) {
            .bracket-match {
                padding: 6px !important;
                margin: 5px 0 !important;
                box-sizing: border-box !important;
                width: 100% !important;
                min-width: calc(100% - 4px) !important;
            }

            .bracket-player {
                display: flex !important;
                flex-direction: row !important;
                align-items: center;
                gap: 8px;
                width: 100%;
                margin: 2px 0 !important;
                box-sizing: border-box !important;
            }

            .player-name {
                flex: 1 1 auto !important;
                min-width: 0 !important;
                max-width: none !important;
                text-align: left;
                padding: 6px 8px !important;
                font-size: 0.8rem;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
                height: auto;
                min-height: 44px;
                display: flex;
                align-items: center;
                box-sizing: border-box !important;
            }

            .score-input {
                flex: 0 0 auto !important;
                width: 60px !important;
                min-width: 60px !important;
                max-width: 60px !important;
                padding: 6px 4px !important;
                font-size: 0.9rem;
                box-sizing: border-box !important;
            }
        }

        @media (max-width: 380px) {
            .bracket-match {
                min-width: calc(100% - 6px) !important;
            }

            .player-name,
            .score-input {
                width: 45px !important;
                min-width: 45px !important;
                max-width: 45px !important;
                font-size: 0.75rem;
                padding: 4px 2px !important;
            }
        }

        @media (max-width: 767px) and (orientation: landscape) {
            .bracket-player {
                display: flex !important;
                flex-direction: row !important;
                align-items: center;
                width: 100% !important;
            }

            .player-name {
                flex: 1 1 auto !important;
                min-width: 0 !important;
                width: auto !important;
                max-width: none !important;
                text-align: left !important;
                white-space: nowrap !important;
                overflow: hidden !important;
                text-overflow: ellipsis !important;
            }

            .score-input {
                flex: 0 0 auto !important;
                width: 50px !important;
                min-width: 50px !important;
                max-width: 50px !important;
            }

            .bracket-match {
                min-width: 280px !important;
            }
        }

        .knockout-header {
            position: relative;
            padding-right: 80px;
            margin-right: 0;
        }

        @media (max-width: 768px) {
            .knockout-header {
                padding-right: 70px;
            }
        }

     @media (max-width: 480px) {
    .knockout-header {
        padding-right: 60px;
    }
    
    .language-switcher {
        top: 5px;
        right: 5px;
    }
    
    .lang-btn {
        padding: 6px 8px;
        font-size: 11px;
        min-width: 45px;
    }

    h1 {
        margin-top: 50px;
        font-size: 1.2rem;
        min-height: 55px;
        gap: 8px;
        padding: 8px 10px;
    }
}
    
    .flag {
        font-size: 12px;
    }
}

/* KONTENER NA PRZYCISKI W NAGWKU - FLEXBOX */
.header-buttons-container {
    position: absolute;
    top: 15px;
    right: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
    z-index: 1000;
    flex-wrap: nowrap;
}

/* KONTENER NA PRZYCISKI W NAGWKU - FLEXBOX */
.header-buttons-container {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 1000;
    flex-wrap: nowrap;
}

/* PRZECZNIK JZYKA */
.header-buttons-container .language-switcher {
    position: static !important;
    margin: 0;
    order: 1;
}

/* KONTENER NA PRZYCISKI W NAGWKU - FLEXBOX */
.header-buttons-container {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    align-items: center;
    gap: 10px;
    z-index: 1000;
    flex-wrap: nowrap;
}

/* PRZECZNIK JZYKA */
.header-buttons-container .language-switcher {
    position: static !important;
    margin: 0;
    order: 1;
}

/* PRZYCISK ZWIJANIA - W KONTENERZE OBOK JZYKA */
.header-buttons-container .collapse-button {
    position: static !important;
    top: auto !important;
    right: auto !important;
    margin: 0;
    background: #555;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.8rem;
    z-index: 10;
    transition: background 0.3s ease;
    white-space: nowrap;
    max-width: 80px;
    order: 2;
    flex-shrink: 0;
}

.header-buttons-container .collapse-button:hover {
    background: #777;
}

/* DLA MOBILE - OPTYMALIZACJA */
@media (max-width: 767px) {
    .header-buttons-container {
        top: 8px;
        right: 8px;
        gap: 8px;
    }
    
    .header-buttons-container .language-switcher {
        transform: scale(0.85);
    }
    
    .header-buttons-container .collapse-button {
        padding: 8px 12px;
        font-size: 0.85rem;
        min-width: 70px;
    }
    
    .header-buttons-container .lang-btn {
        padding: 6px 8px;
        font-size: 11px;
        min-width: 40px;
    }
}

/* DLA BARDZO MAYCH EKRANW */
@media (max-width: 480px) {
    .header-buttons-container {
        gap: 6px;
    }
    
    .header-buttons-container .language-switcher {
        transform: scale(0.8);
    }
    
    .header-buttons-container .collapse-button {
        padding: 6px 10px;
        font-size: 0.8rem;
        min-width: 65px;
    }
    
    .header-buttons-container .lang-btn {
        padding: 5px 7px;
        font-size: 10px;
        min-width: 38px;
    }
}

/* ZAPEWNIJ MIEJSCE DLA PRZYCISKW W NAGWKU */
.knockout-header {
    padding-right: 180px !important;
    position: relative;
    min-height: 50px;
    display: flex;
    align-items: center;
}
/* --- NOWY STYL DLA FORMULARZA USTAWIE --- */

/* Kontener dla wierszy formularza */
.form-row {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    margin-bottom: 15px;
    align-items: flex-end;
}

.form-col-grow {
    flex: 1 1 calc(50% - 10px); 
    min-width: 250px;
}

.form-col-shrink {
    flex: 0 0 auto;
}

.styled-label {
    display: block;
    font-weight: 600;
    color: #34495e;
    margin-bottom: 6px;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.styled-input {
    width: 100%;
    padding: 10px 15px;
    height: 40px;
    border: 2px solid #e3f2fd;
    background-color: #f8fbff;
    border-radius: 8px;
    font-size: 1rem;
    color: #2c3e50;
    transition: all 0.3s ease;
    box-sizing: border-box;
}

.styled-input:focus {
    border-color: #3498db;
    background-color: #fff;
    outline: none;
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
}

.styled-textarea {
    min-height: 120px;
    height: auto;
    resize: vertical;
    font-family: inherit;
}

.checkbox-wrapper {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px;
    background: #f0f8ff;
    border: 1px solid #e3f2fd;
    border-radius: 8px;
    cursor: pointer;
    transition: background 0.2s;
}
.checkbox-wrapper:hover {
    background: #e3f2fd;
}
.checkbox-input {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

#groupSection {
    margin-top: 45px !important;
}

.toggle-switch-row {
    display: flex;
    flex-wrap: wrap;
    gap: 60px;
    margin-bottom: 30px;
    align-items: flex-start;
}

.toggle-switch-container {
    display: flex;
    flex-direction: column;
    gap: 10px;
    min-width: 200px;
}

.toggle-switch-label {
    font-weight: 600;
    color: #34495e;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 5px;
}

.toggle-switch {
    display: flex;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid #3498db;
    width: fit-content;
}

.toggle-switch-btn {
    background: #e3f2fd;
    border: none;
    padding: 10px 20px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s;
    flex: 1;
    color: #2c3e50;
    font-size: 14px;
    min-width: 60px;
    text-align: center;
}

.toggle-switch-btn:hover {
    background: #bbdefb;
    color: #2c3e50;
}

.toggle-switch-btn.active {
    background: #3498db;
    color: white;
}

@media (max-width: 767px) {
    .toggle-switch-row {
        flex-direction: column;
        gap: 25px;
    }
    
    .toggle-switch-container {
        width: 100%;
    }
    
    .toggle-switch {
        width: 100%;
    }
}

.vertical-form {
    display: block;
    padding: 0;
}

.vertical-form .form-col-grow {
   display: block;
    width: 100%;
    min-width: 100%;
    margin: 0;
    box-sizing: border-box;
}

#tournamentNameInput {
    width: 460px;
    background: linear-gradient(135deg, #ffffff, #e3f2fd);
    border: 2px solid #3498db;
    border-left: 6px solid #1e5799;
    box-shadow: 0 4px 6px rgba(52, 152, 219, 0.1);
    border-radius: 10px;
    padding: 12px 20px;
    font-size: 16px;
    font-weight: 500;
}

#subTitleInput {
    width: 350px;
    background: linear-gradient(135deg, #ffffff, #e8f5e9);
    border: 2px solid #27ae60;
    border-left: 6px solid #219653;
    box-shadow: 0 4px 6px rgba(39, 174, 96, 0.1);
    border-radius: 10px;
    padding: 12px 20px;
    font-size: 16px;
    font-weight: 500;
}

@media (max-width: 767px) {
    #tournamentNameInput,
    #subTitleInput {
        width: 100%;
    }
}
    </style>
</head>
<body>
<div class="container">
    <h1 data-i18n="tournamentName">Turniej Tenisa Stoowego</h1>
 
    <div class="control-panel" id="controlPanel">
        <h2 class="knockout-header" id="settingsHeader" data-i18n="settings">Ustawienia turnieju</h2>
        <div class="header-buttons-container">
            <div class="language-switcher">
                <button class="lang-btn active" data-lang="pl" onclick="setLanguage('pl')">
                    <span class="flag">叼</span> PL
                </button>
                <button class="lang-btn" data-lang="en" onclick="setLanguage('en')">
                    <span class="flag"></span> EN
                </button>
            </div>
            
            <button class="collapse-button" onclick="toggleCollapse('controlPanel')" data-i18n="collapse">Zwi</button>
        </div>
             
       <div class="collapsible-content">
    
    <div class="form-row vertical-form">
    <div class="form-col-grow"> 
        <label class="styled-label" for="tournamentNameInput" data-i18n="tournamentName">Nazwa turnieju</label>
        <input type="text" id="tournamentNameInput" class="styled-input" data-i18n-placeholder="enterTournamentName" placeholder="Np. Turniej Tenisa Stoowego" oninput="updateTournamentTitle(); saveState();">
    </div>
    <div class="form-col-grow"> 
        <label class="styled-label" for="subTitleInput" data-i18n="category">Kategoria</label>
        <input type="text" id="subTitleInput" class="styled-input category-input" data-i18n-placeholder="enterCategory" placeholder="Np. Amatorzy" oninput="handleCategoryInput(); saveState();">
    </div>
</div>
    </div>

    <div class="toggle-switch-row">
        <div class="toggle-switch-container">
            <div class="toggle-switch-label" data-i18n="groupMode">Tryb podziau na grupy</div>
            <div class="toggle-switch">
                <button class="toggle-switch-btn active" id="btn-mode-auto" onclick="setMode('auto')" data-i18n="autoMode">Automatyczny</button>
                <button class="toggle-switch-btn" id="btn-mode-manual" onclick="setMode('manual')" data-i18n="manualMode">Rczny</button>
            </div>
        </div>
        
        <div class="toggle-switch-container">
            <div class="toggle-switch-label" data-i18n="consolationTournament">Turniej Pocieszenia</div>
            <div class="toggle-switch">
                <button class="toggle-switch-btn active" id="btn-consolation-no" onclick="setConsolationMode('no')" data-i18n="no">Nie</button>
                <button class="toggle-switch-btn" id="btn-consolation-yes" onclick="setConsolationMode('yes')" data-i18n="yes">Tak</button>
            </div>
        </div>
    </div>
    
    <input type="hidden" id="mode" value="auto">
    <input type="hidden" id="consolationMode" value="no">

    <div id="auto-panel">
        <div class="form-row">
            <div class="form-col-grow">
                <label class="styled-label" for="playersAuto" data-i18n="players">Lista zawodnik贸w</label>
                <textarea id="playersAuto" class="styled-input styled-textarea" data-i18n-placeholder="enterPlayersAuto" placeholder="Wpisz zawodnik贸w (jeden na linijk)" oninput="saveState()"></textarea>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-col-shrink">
                <label class="styled-label" for="numGroupsAuto" data-i18n="numberOfGroups">Liczba grup</label>
                <input type="number" id="numGroupsAuto" class="styled-input" style="width: 100px; text-align: center;" min="1" max="12" value="4" oninput="saveState()">
            </div>
            <div class="form-col-shrink">
                <label class="styled-label" for="numQualifiedPlayers" data-i18n="qualifiedPerGroup">Awansuj z grupy</label>
                <input type="number" id="numQualifiedPlayers" class="styled-input" style="width: 100px; text-align: center;" min="1" max="8" value="2" oninput="saveState()">
            </div>
        </div>
    </div>

    <div id="manual-panel" style="display:none;">
        <div class="form-row">
            <div class="form-col-grow">
                <label class="styled-label" for="playersManual" data-i18n="players">Lista zawodnik贸w (Rcznie)</label>
                <textarea id="playersManual" class="styled-input styled-textarea" data-i18n-placeholder="enterPlayersManual" placeholder="Wpisz zawodnik贸w (jeden na linijk)" oninput="saveState()"></textarea>
            </div>
        </div>
        <div class="form-row">
            <div class="form-col-shrink">
                <label class="styled-label" for="numGroupsManual" data-i18n="numberOfGroups">Liczba grup</label>
                <input type="number" id="numGroupsManual" class="styled-input" style="width: 100px; text-align: center;" min="1" max="12" value="4" onchange="renderManualGroups(); saveState()">
            </div>
            <div class="form-col-shrink">
                <label class="styled-label" for="numQualifiedPlayersManual" data-i18n="qualifiedPerGroup">Awansuj z grupy</label>
                                <input type="number" id="numQualifiedPlayersManual" class="styled-input" style="width: 100px; text-align: center;" min="1" max="8" value="2" oninput="saveState()">
            </div>
        </div>
        <div id="manual-groups"></div>
    </div>

    <div class="control-buttons-row">
        <button onclick="exportResultsToText()" data-i18n="exportResults">Eksportuj wyniki</button>
        <button onclick="saveTournamentToFile()" data-i18n="saveTournament">Zapisz turniej</button>
        <button onclick="loadTournamentFromFile()" data-i18n="loadTournament">Wczytaj turniej</button>
        <button onclick="clearTournamentData()" class="clear-data-button" data-i18n="clearData">Wyczy dane</button>
    </div>
</div>
    <div class="main-group-section" id="groupSection">
        <h2 class="knockout-header" id="groupsHeader" data-i18n="groupStage">Faza Grupowa</h2>
        <button class="collapse-button" onclick="toggleCollapse('groupSection')" data-i18n="collapse">Zwi</button>
        <div class="collapsible-content">
            <div class="group-buttons-container">
                <button id="generateAutoGroupsBtn" onclick="generateGroups(); saveState()" data-i18n="generateGroups">Generuj tabele grupowe </button>
                <button id="generateManualGroupsBtn" onclick="generateManualGroups(); saveState()" style="display:none;" data-i18n="generateGroups">Generuj tabele grupowe </button>
            </div>

            <div class="group-view-toggle">
                <button class="view-toggle-btn active" data-view="table" data-i18n="tableView">Tabela</button>
                <button class="view-toggle-btn" data-view="schedule" data-i18n="scheduleView">Harmonogram</button>
            </div>

            <div id="groups-container"></div>
        </div>
    </div>

    <div class="knockout-container" id="knockoutSection">
        <h2 class="knockout-header" id="knockoutHeader" data-i18n="knockoutStage">Faza Pucharowa</h2>
        <button class="collapse-button" onclick="toggleCollapse('knockoutSection')" data-i18n="collapse">Zwi</button>
        <div class="collapsible-content">
            <button onclick="generateBracket(); saveState()" data-i18n="generateBracket">Generuj drabink pucharow </button>
            <div class="bracket" id="knockout-bracket"></div>
        </div>
    </div>

    <div class="consolation-container" id="consolationSection" style="display:none;">
        <h2 class="knockout-header" id="consolationHeader" data-i18n="consolationTournament">Turniej Pocieszenia</h2>
        <button class="collapse-button" onclick="toggleCollapse('consolationSection')" data-i18n="collapse">Zwi</button>
        <div class="collapsible-content">
            <button onclick="generateConsolationBracket(); saveState()" data-i18n="generateConsolation">Generuj drabink pocieszenia </button>
            <div class="bracket" id="consolation-bracket"></div>
        </div>
    </div>
</div>

<script>
function setMode(selectedMode) {
    document.getElementById('mode').value = selectedMode;
    
    const btnAuto = document.getElementById('btn-mode-auto');
    const btnManual = document.getElementById('btn-mode-manual');
    
    if (selectedMode === 'auto') {
        btnAuto.classList.add('active');
        btnManual.classList.remove('active');
    } else {
        btnAuto.classList.remove('active');
        btnManual.classList.add('active');
    }

    switchMode();
    saveState();
}

function setConsolationMode(value) {
    document.getElementById('consolationMode').value = value;
    
    const btnYes = document.getElementById('btn-consolation-yes');
    const btnNo = document.getElementById('btn-consolation-no');
    
    if (value === 'yes') {
        btnYes.classList.add('active');
        btnNo.classList.remove('active');
        document.getElementById('consolationSection').style.display = 'block';
    } else {
        btnYes.classList.remove('active');
        btnNo.classList.add('active');
        document.getElementById('consolationSection').style.display = 'none';
    }
    
    updateClassification();
    saveState();
}

// ================= SYSTEM TUMACZE =================
const translations = {
    pl: {
        tournamentName: "Turniej Tenisa Stoowego",
        groupStage: "Faza grupowa",
        knockoutStage: "Faza pucharowa",
        consolationTournament: "Turniej Pocieszenia",
        settings: "Ustawienia turnieju",
        generateGroups: "Generuj tabele grupowe",
        generateBracket: "Generuj drabink pucharow",
        generateConsolation: "Generuj drabink pocieszenia",
        exportResults: "Eksportuj wyniki",
        saveTournament: "Zapisz turniej",
        loadTournament: "Wczytaj turniej",
        clearData: "Wyczy dane turniejowe",
        collapse: "Zwi",
        players: "Zawodnicy",
        enterPlayersAuto: "Wpisz zawodnik贸w (jeden na linijk) - tryb auto",
        enterPlayersManual: "Wpisz zawodnik贸w (jeden na linijk) - tryb rczny",
        enterTournamentName: "Np. Turniej Tenisa Stoowego",
        enterCategory: "Np. Amatorzy",
        category: "Kategoria",
        groupMode: "Tryb podziau na grupy",
        autoMode: "Automatyczny",
        manualMode: "Rczny",
        numberOfGroups: "Liczba grup",
        qualifiedPerGroup: "Liczba kwalifikujcych si z grupy",
        tableView: "Tabela",
        scheduleView: "Harmonogram",
        yes: "Tak",
        no: "Nie",
        inProgress: "Trwa"
    },
    en: {
        tournamentName: "Table Tennis Tournament",
        groupStage: "Group Stage",
        knockoutStage: "Knockout Stage",
        consolationTournament: "Consolation Tournament",
        settings: "Tournament Settings",
        generateGroups: "Generate Group Tables",
        generateBracket: "Generate Knockout Bracket",
        generateConsolation: "Generate Consolation Bracket",
        exportResults: "Export Results",
        saveTournament: "Save Tournament",
        loadTournament: "Load Tournament",
        clearData: "Clear Tournament Data",
        collapse: "Collapse",
        players: "Players",
        enterPlayersAuto: "Enter players (one per line) - auto mode",
        enterPlayersManual: "Enter players (one per line) - manual mode",
        enterTournamentName: "e.g. Table Tennis Tournament",
        enterCategory: "e.g. Amateurs",
        category: "Category",
        groupMode: "Group division mode",
        autoMode: "Automatic",
        manualMode: "Manual",
        numberOfGroups: "Number of groups",
        qualifiedPerGroup: "Number of qualified per group",
        tableView: "Table",
        scheduleView: "Schedule",
        yes: "Yes",
        no: "No",
        inProgress: "Live"
    }
};

let currentLanguage = localStorage.getItem('appLanguage') || 'pl';

let appState = {
    lastSave: 0,
    isSaving: false
};

function setMode(modeValue) {
    const modeInput = document.getElementById('mode');
    if (modeInput) {
        modeInput.value = modeValue;
    }
    
    switchMode();
    saveState();
}

function setupAutoSave() {
    const inputs = document.querySelectorAll('input, textarea, select');
    inputs.forEach(input => {
        const eventType = input.type === 'checkbox' ? 'change' : 'input';
        input.addEventListener(eventType, function() {
            debouncedSave();
        });
    });
    
    document.addEventListener('click', function(e) {
        if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
            setTimeout(debouncedSave, 100);
        }
    });
}

let saveTimeout;
function debouncedSave() {
    if (saveTimeout) clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
        if (!appState.isSaving) {
            saveState();
        }
    }, 500);
}

window.addEventListener('beforeunload', function() {
    console.log("Beforeunload - saving state");
    saveState();
});

document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        console.log("App hidden - saving state");
        saveState();
    }
});

window.addEventListener('orientationchange', function() {
    console.log("Orientation change - immediate save");
    saveState();
});

setInterval(function() {
    if (!document.hidden) {
        saveState();
    }
}, 2000);

const originalSaveState = saveState;
saveState = function() {
    if (appState.isSaving) return;
    
    appState.isSaving = true;
    appState.lastSave = Date.now();
    
    try {
        originalSaveState();
        console.log("State saved successfully");
    } catch (error) {
        console.error("Save state error:", error);
        try {
            const fallbackData = {
                tournamentName: document.getElementById('tournamentNameInput').value,
                playersAuto: document.getElementById('playersAuto').value,
                playersManual: document.getElementById('playersManual').value,
                mode: document.getElementById('mode').value,
                consolationMode: document.getElementById('consolationMode').value,
                timestamp: Date.now()
            };
            sessionStorage.setItem('fallbackSave', JSON.stringify(fallbackData));
        } catch (e) {
            console.error("Fallback save also failed:", e);
        }
    } finally {
        appState.isSaving = false;
    }
}

const originalLoadState = loadState;
loadState = function() {
    try {
        originalLoadState();
        console.log("State loaded successfully");
    } catch (error) {
        console.error("Load state error:", error);
        try {
            const fallback = sessionStorage.getItem('fallbackSave');
            if (fallback) {
                const data = JSON.parse(fallback);
                document.getElementById('tournamentNameInput').value = data.tournamentName || '';
                document.getElementById('playersAuto').value = data.playersAuto || '';
                document.getElementById('playersManual').value = data.playersManual || '';
                document.getElementById('mode').value = data.mode || 'auto';
                document.getElementById('consolationMode').value = data.consolationMode || 'no';
                switchMode();
                setConsolationMode(data.consolationMode || 'no');
                console.log("Fallback data loaded");
            }
        } catch (e) {
            console.error("Fallback load also failed:", e);
        }
    }
}

window.addEventListener('load', function() {
    setTimeout(() => {
        setupAutoSave();
        loadState();
    }, 1000);
});

function setLanguage(lang) {
    if (translations[lang]) {
        currentLanguage = lang;
        localStorage.setItem('appLanguage', lang);
        applyTranslations();
        updateLanguageSwitch();
        
        renderGroups();
        displayBracket();
        displayConsolationBracket();
        updateClassification();
        updateSubTitleDisplay();
        
        saveTournamentState();
    }
}

function t(key) {
    return translations[currentLanguage]?.[key] || translations.pl[key] || key;
}

function applyTranslations() {
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        element.textContent = t(key);
    });
    
    document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
        const key = element.getAttribute('data-i18n-placeholder');
        element.placeholder = t(key);
    });
    
    document.querySelectorAll('option[data-i18n]').forEach(option => {
        const key = option.getAttribute('data-i18n');
        option.textContent = t(key);
    });

    const playersTranslation = translations[currentLanguage].players || 'Zawodnicy';
    const groupTranslation = translations[currentLanguage].group || 'Grupa';

    const manualGroupCount = parseInt(document.getElementById('numGroupsManual').value) || 0;

    for (let i = 0; i < manualGroupCount; i++) {
        const label = document.getElementById(`manual-group-label-${i}`);
        if (label) {
            label.textContent = `${playersTranslation} ${groupTranslation} ${i + 1}:`;
        }
    }
}

function updateLanguageSwitch() {
    document.querySelectorAll('.lang-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.lang === currentLanguage);
    });
}

function detectLanguage() {
    const browserLang = navigator.language.split('-')[0];
    return ['pl', 'en'].includes(browserLang) ? browserLang : 'pl';
}

function saveTournamentState() {
    saveState();
}

// ================= ORYGINALNY KOD APLIKACJI =================
let groupPlayers = [];
let groupResults = [];
let groupStandings = [];
let manualGroupPlayers = [];
let manualGroupResults = [];
let manualGroupStandings = [];
let autoSubTitle = '';
let manualSubTitle = '';
let autoKnockoutMatches = { quarterfinals: [], semifinals: [], final: null, thirdPlace: null };
let manualKnockoutMatches = { quarterfinals: [], semifinals: [], final: null, thirdPlace: null };
let autoConsolationMatches = { semifinals: [], fifthPlace: null, seventhPlace: null };
let manualConsolationMatches = { semifinals: [], fifthPlace: null, seventhPlace: null };
let autoPlayerColors = {};
let manualPlayerColors = {};
let activeGroupView = 'table';
let androidInterface = null;
var shouldSave = false;
if (typeof Android !== 'undefined') {
    androidInterface = Android;
}

const nextMatchMap = {
    qf1: { nextRound: 'semifinals', nextMatchIndex: 0, nextPlayer: 1, loserToConsolation: true, loserConsolationMatch: 'csf1', loserConsolationPlayer: 1 },
    qf2: { nextRound: 'semifinals', nextMatchIndex: 0, nextPlayer: 2, loserToConsolation: true, loserConsolationMatch: 'csf1', loserConsolationPlayer: 2 },
    qf3: { nextRound: 'semifinals', nextMatchIndex: 1, nextPlayer: 1, loserToConsolation: true, loserConsolationMatch: 'csf2', loserConsolationPlayer: 1 },
    qf4: { nextRound: 'semifinals', nextMatchIndex: 1, nextPlayer: 2, loserToConsolation: true, loserConsolationMatch: 'csf2', loserConsolationPlayer: 2 },
    sf1: { nextRound: 'final', nextPlayer: 1, loserMatchId: 'third', loserPlayerPos: 1 },
    sf2: { nextRound: 'final', nextPlayer: 2, loserMatchId: 'third', loserPlayerPos: 2 },
    third: null,
    final: null
};

const nextConsolationMatchMap = {
    csf1: { nextRoundWinner: 'fifth', winnerPlayerPos: 1, nextRoundLoser: 'seventh', loserPlayerPos: 1 },
    csf2: { nextRoundWinner: 'fifth', winnerPlayerPos: 2, nextRoundLoser: 'seventh', loserPlayerPos: 2 },
    fifth: null,
    seventh: null
};

function saveToAndroidFile(content, filename, fileType) {
    if (androidInterface) {
        androidInterface.saveFile(content, filename, fileType);
    } else {
        fallbackSaveFile(content, filename, fileType);
    }
}

function loadFromAndroidFile() {
    if (androidInterface) {
        androidInterface.loadFile();
    } else {
        document.getElementById('fileInput').click();
    }
}

function fallbackSaveFile(content, filename, fileType) {
    const blob = new Blob([content], { type: fileType });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.style.display = 'none';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function onFileLoaded(fileContent) {
    try {
        const tournamentData = JSON.parse(fileContent);
        showLoadDialog(tournamentData);
    } catch (error) {
        alert(t('loadError'));
        console.error('Error parsing tournament file:', error);
    }
}

function onFileLoadedBase64(base64Content) {
    try {
        const rawString = atob(base64Content);
        const bytes = new Uint8Array(rawString.length);
        for (let i = 0; i < rawString.length; i++) {
            bytes[i] = rawString.charCodeAt(i);
        }
        const decoder = new TextDecoder('utf-8');
        const decodedString = decoder.decode(bytes);
        onFileLoaded(decodedString);
    } catch (error) {
        alert(t('loadError'));
        console.error('Error in onFileLoadedBase64:', error);
    }
}

function onSaveComplete(filename) {
    alert(t('saveSuccess') + filename);
}

function onSaveError(error) {
    alert(t('saveError') + error);
}

function switchGroupView(view) {
    activeGroupView = view;
    document.querySelectorAll('.view-toggle-btn').forEach(btn => {
        if (btn.dataset.view === view) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });
    renderGroups();
    saveState();
}

function generateGroupMatches(groupIndex, players, groupResults) {
    const matches = [];
    for (let i = 0; i < players.length; i++) {
        for (let j = i + 1; j < players.length; j++) {
            const player1 = players[i];
            const player2 = players[j];
            const result = groupResults[i][j] || '';
            matches.push({
                player1Index: i,
                player2Index: j,
                player1: player1,
                player2: player2,
                result: result
            });
        }
    }
    return matches;
}

function renderGroupSchedule(groupIndex, players, groupResults, container) {
    const matches = generateGroupMatches(groupIndex, players, groupResults);
    if (matches.length === 0) {
        container.innerHTML = '<p>' + t('noMatches') + '</p>';
        return;
    }
    
    // ZACHOWAJ STANY "TRWA" PRZED RENDEROWANIEM
    const previousStates = {};
    matches.forEach(match => {
        const matchId = `match-${groupIndex}-${match.player1Index}-${match.player2Index}`;
        if (localStorage.getItem(`matchProgress_${matchId}`) === 'true') {
            previousStates[matchId] = true;
        }
    });
    
    let scheduleHTML = '';
    matches.forEach((match, matchIndex) => {
        const isPlayed = match.result !== '';
        const statusClass = isPlayed ? 'played' : 'pending';
        const statusText = isPlayed ? t('played') : t('waiting');
        const [score1, score2] = match.result ? match.result.split(':') : ['', ''];
        const matchId = `match-${groupIndex}-${match.player1Index}-${match.player2Index}`;
        
        // SPRAWD殴 CZY BY ZAZNACZONY PRZED RENDEROWANIEM
        const wasInProgress = previousStates[matchId] === true;
        
        scheduleHTML += `
            <div class="match-item ${isPlayed ? 'match-played' : ''} ${wasInProgress ? 'match-in-progress' : ''}" id="${matchId}">
                <div class="match-players">
                    <div class="match-player">${match.player1}</div>
                    <div class="match-player vs">${t('vs')}</div>
                    <div class="match-player">${match.player2}</div>
                </div>
                <div class="match-result">
                    <input type="text" class="match-result-input" 
                           placeholder="0" value="${score1}" 
                           onchange="updateMatchFromSchedule(${groupIndex}, ${match.player1Index}, ${match.player2Index}, this, 'player1')">
                    <span>:</span>
                    <input type="text" class="match-result-input" 
                           placeholder="0" value="${score2}" 
                           onchange="updateMatchFromSchedule(${groupIndex}, ${match.player1Index}, ${match.player2Index}, this, 'player2')">
                </div>
                <div class="match-status ${statusClass}">${statusText}</div>
                <div class="match-checkbox">
                    <label class="in-progress-label">
                        <input type="checkbox" class="match-inprogress-checkbox" 
                               ${wasInProgress ? 'checked' : ''}
                               onchange="toggleMatchInProgress(${groupIndex}, ${match.player1Index}, ${match.player2Index}, this)">
                        ${t('inProgress')}
                    </label>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = scheduleHTML;
}

// NOWA FUNKCJA: Zaznaczanie/odznaczanie "Trwa"
function toggleMatchInProgress(groupIndex, player1Index, player2Index, checkbox) {
    const matchId = `match-${groupIndex}-${player1Index}-${player2Index}`;
    const matchItem = document.getElementById(matchId);
    
    if (checkbox.checked) {
        matchItem.classList.add('match-in-progress');
        localStorage.setItem(`matchProgress_${matchId}`, 'true');
    } else {
        matchItem.classList.remove('match-in-progress');
        localStorage.removeItem(`matchProgress_${matchId}`);
    }
    
    saveState();
}

// I w updateMatchFromSchedule():
function updateMatchFromSchedule(groupIndex, player1Index, player2Index, inputElement, player) {
    const mode = document.getElementById('mode').value;
    const currentGroupResults = mode === 'manual' ? manualGroupResults : groupResults;
    const score1Input = inputElement.parentElement.querySelector('.match-result-input:nth-child(1)');
    const score2Input = inputElement.parentElement.querySelector('.match-result-input:nth-child(3)');
    const score1 = score1Input.value.trim();
    const score2 = score2Input.value.trim();
    
    if (score1 && score2 && (!/^\d+$/.test(score1) || !/^\d+$/.test(score2))) {
        alert(t('invalidScore'));
        score1Input.value = '';
        score2Input.value = '';
        return;
    }
    
    const matchId = `match-${groupIndex}-${player1Index}-${player2Index}`;
    const matchItem = document.getElementById(matchId);
    
    if (score1 && score2) {
        const result = `${score1}:${score2}`;
        
        // ZAPISZ WYNIK BEZ RENDEROWANIA CAYCH GRUP
        saveResultWithoutRender(groupIndex, player1Index, player2Index, result, mode);
        
        // 1. ODZNACZ "TRWA" jeli jest zaznaczone
        const checkbox = matchItem.querySelector('.match-inprogress-checkbox');
        if (checkbox && checkbox.checked) {
            checkbox.checked = false;
            matchItem.classList.remove('match-in-progress');
            localStorage.removeItem(`matchProgress_${matchId}`);
        }
        
        // 2. DODAJ KLAS .match-played (ZIELONE PODWIETLENIE)
        matchItem.classList.add('match-played');
        
        // 3. Zaktualizuj status meczu
        const statusDiv = matchItem.querySelector('.match-status');
        if (statusDiv) {
            statusDiv.textContent = t('played');
            statusDiv.className = 'match-status played';
        }
        
    } else if (!score1 && !score2) {
        saveResultWithoutRender(groupIndex, player1Index, player2Index, '', mode);
        
        // USU KLAS .match-played (bo usunito wynik)
        matchItem.classList.remove('match-played');
        
        // Zaktualizuj status
        const statusDiv = matchItem.querySelector('.match-status');
        if (statusDiv) {
            statusDiv.textContent = t('waiting');
            statusDiv.className = 'match-status pending';
        }
    }
    
    saveState();
}

// NOWA FUNKCJA: Zapisz wynik bez renderowania caych grup
function saveResultWithoutRender(groupIndex, player1Index, opponentIndex, value, mode) {
    if (value && !/^\d+:\d+$/.test(value)) {
        alert(t('invalidScoreFormat'));
        return;
    }

    const currentGroupResults = mode === 'manual' ? manualGroupResults : groupResults;
    currentGroupResults[groupIndex][player1Index][opponentIndex] = value;
    if (value) {
        const [a, b] = value.split(':').map(Number);
        currentGroupResults[groupIndex][opponentIndex][player1Index] = `${b}:${a}`;
    } else {
        currentGroupResults[groupIndex][opponentIndex][player1Index] = '';
    }
    
    // NIE WYWOUJ renderGroups() - tylko przelicz stan
    calculateAllStandings();
}
function handleCategoryInput() {
    const mode = document.getElementById('mode').value;
    const subTitleInput = document.getElementById('subTitleInput');
    if (mode === 'manual') {
        manualSubTitle = subTitleInput.value;
    } else {
        autoSubTitle = subTitleInput.value;
    }
    updateSubTitleDisplay();
    saveState();
}

function updateTournamentTitle() {
    const input = document.getElementById('tournamentNameInput');
    const h1 = document.querySelector('h1');
    const currentPrefix = '';

    if (input && h1) {
        const newTitle = input.value.trim() === '' ? t('tournamentName') : input.value.trim();
        document.title = currentPrefix + newTitle;
        h1.textContent = currentPrefix + newTitle;
    }
}

function updateSubTitleDisplay() {
    const mode = document.getElementById('mode').value;
    const currentSubTitle = mode === 'manual' ? manualSubTitle : autoSubTitle;
    const knockoutHeader = document.getElementById('knockoutHeader');
    const groupsHeader = document.getElementById('groupsHeader');
    const settingsHeader = document.getElementById('settingsHeader');
    const consolationHeader = document.getElementById('consolationHeader');

    if (knockoutHeader) {
        knockoutHeader.textContent = currentSubTitle !== '' ? t('knockoutStage') + ' - ' + currentSubTitle : t('knockoutStage');
    }
   if (groupsHeader) {
    if (currentSubTitle !== '') {
        groupsHeader.textContent = t('groupStage') + ' - ' + currentSubTitle;
    } else {
        groupsHeader.textContent = t('groupStage');
    }
}
    if (settingsHeader) {
        settingsHeader.textContent = currentSubTitle !== '' ? t('settings') + ' - ' + currentSubTitle : t('settings');
    }
    if (consolationHeader) {
        consolationHeader.textContent = currentSubTitle !== '' ? t('consolationTournament') + ' - ' + currentSubTitle : t('consolationTournament');
    }
}

function switchMode() {
    const mode = document.getElementById('mode').value;

    const btnAuto = document.getElementById('btn-mode-auto');
    const btnManual = document.getElementById('btn-mode-manual');

    if (btnAuto && btnManual) {
        if (mode === 'auto') {
            btnAuto.classList.add('active');
            btnAuto.style.background = '#3498db';
            btnAuto.style.color = 'white';
            btnManual.classList.remove('active');
            btnManual.style.background = '#e3f2fd';
            btnManual.style.color = '#2c3e50';
        } else {
            btnAuto.classList.remove('active');
            btnAuto.style.background = '#e3f2fd';
            btnAuto.style.color = '#2c3e50';
            btnManual.classList.add('active');
            btnManual.style.background = '#3498db';
            btnManual.style.color = 'white';
        }
    }

    const autoPanel = document.getElementById('auto-panel');
    const manualPanel = document.getElementById('manual-panel');
    
    if (autoPanel) autoPanel.style.display = mode === 'auto' ? 'block' : 'none';
    if (manualPanel) manualPanel.style.display = mode === 'auto' ? 'none' : 'block';

    const genAutoBtn = document.getElementById('generateAutoGroupsBtn');
    const genManualBtn = document.getElementById('generateManualGroupsBtn');

    if (genAutoBtn) genAutoBtn.style.display = mode === 'auto' ? 'inline-block' : 'none';
    if (genManualBtn) genManualBtn.style.display = mode === 'auto' ? 'none' : 'inline-block';

    const autoBtnContainer = document.getElementById('generateAutoGroupsBtn')?.parentNode;
    if (autoBtnContainer) autoBtnContainer.style.textAlign = 'left';

    const subTitleInput = document.getElementById('subTitleInput');
    if (mode === 'manual') {
        if (subTitleInput) subTitleInput.value = manualSubTitle;
    } else {
        if (subTitleInput) subTitleInput.value = autoSubTitle;
    }

    renderGroups();
    displayBracket();
    displayConsolationBracket();
    updateClassification();
    updateSubTitleDisplay();
}

function renderManualGroups() {
    const manualGroupCount = parseInt(document.getElementById('numGroupsManual').value) || 0;
    const container = document.getElementById('manual-groups');
    if (!container) return;
    
    container.innerHTML = '';
    
    for (let i = 0; i < manualGroupCount; i++) {
        container.innerHTML += `
            <div class="form-row vertical-form" style="margin-bottom: 10px;">
                <div class="form-col-grow">
                    <label class="styled-label" id="manual-group-label-${i}">
                        ${t('players')} ${t('group')} ${i + 1}:
                    </label>
                    <textarea id="manual-group-${i}" class="styled-input styled-textarea" 
                              data-i18n-placeholder="enterPlayersManual" 
                              placeholder="${t('enterPlayersManual')}" 
                              oninput="saveManualGroupsInput()"></textarea>
                </div>
            </div>`;
    }

    applyTranslations();
}

function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
}

function generateGroups() {
    const players = document.getElementById('playersAuto').value
        .trim()
        .split('\n')
        .map(p => p.trim())
        .filter(p => p);
    const numGroups = parseInt(document.getElementById('numGroupsAuto').value);

    if (players.length === 0) {
        alert(t('enterPlayersFirst'));
        return;
    }

    groupPlayers = [];
    groupResults = [];
    groupStandings = [];

    for (let i = 0; i < numGroups; i++) {
        groupPlayers.push([]);
    }

    shuffleArray(players);

    for (let i = 0; i < players.length; i++) {
        const groupIndex = i % numGroups;
        groupPlayers[groupIndex].push(players[i]);
    }

    groupPlayers.forEach((playersInGroup, groupIndex) => {
        const groupSize = playersInGroup.length;
        groupResults[groupIndex] = Array(groupSize).fill().map(() => Array(groupSize).fill(''));
    });

    renderGroups();
}

function generateManualGroups() {
    const manualGroupCount = parseInt(document.getElementById('numGroupsManual').value);
    manualGroupPlayers = [];
    manualGroupResults = [];
    manualGroupStandings = [];
    let atLeastOne = false;

    for (let i = 0; i < manualGroupCount; i++) {
        const elem = document.getElementById(`manual-group-${i}`);
        const txt = elem ? elem.value.trim().split('\n').map(p => p.trim()).filter(p => p) : [];
        manualGroupPlayers.push(txt);
        if (txt.length > 0) atLeastOne = true;
    }

    if (!atLeastOne) {
        alert(t('enterPlayersFirst'));
        return;
    }

    manualGroupPlayers.forEach((playersInGroup, groupIndex) => {
        const groupSize = playersInGroup.length;
        manualGroupResults[groupIndex] = Array(groupSize).fill().map(() => Array(groupSize).fill(''));
    });

    renderGroups();
}

function calculateAllStandings() {
    const mode = document.getElementById('mode').value;
    const currentGroupPlayers = mode === 'manual' ? manualGroupPlayers : groupPlayers;
    const currentGroupResults = mode === 'manual' ? manualGroupResults : groupResults;
    const currentGroupStandings = mode === 'manual' ? manualGroupStandings : groupStandings;

    currentGroupStandings.length = 0;

    currentGroupPlayers.forEach((players, groupIndex) => {
        if (players.length === 0) {
            currentGroupStandings[groupIndex] = [];
            return;
        }

        let playerStats = players.map((player, index) => ({
            playerIndex: index,
            points: 0,
            setsWon: 0,
            setsLost: 0,
            playerName: player
        }));

        players.forEach((_, p1Index) => {
            players.forEach((_, p2Index) => {
                if (p1Index !== p2Index) {
                    const result = currentGroupResults[groupIndex][p1Index][p2Index];
                    if (result && result.includes(':')) {
                        const [setsWon, setsLost] = result.split(':').map(Number);
                        playerStats[p1Index].setsWon += setsWon;
                        playerStats[p1Index].setsLost += setsLost;

                        if (setsWon > setsLost) {
                            playerStats[p1Index].points += 3;
                        } else {
                            playerStats[p1Index].points += 1;
                        }
                    }
                }
            });
        });

        playerStats.forEach(stat => {
            stat.setRatio = stat.setsLost > 0 ? (stat.setsWon / stat.setsLost) : (stat.setsWon > 0 ? Infinity : 0);
        });

        playerStats.sort((a, b) => b.points - a.points);

        const finalStandings = [];
        let i = 0;
        while (i < playerStats.length) {
            let j = i;
            while (j < playerStats.length && playerStats[j].points === playerStats[i].points) {
                j++;
            }
            const tiedPlayersBlock = playerStats.slice(i, j);

            if (tiedPlayersBlock.length > 1) {
                const resolvedBlock = resolveTie(tiedPlayersBlock, groupIndex, players, currentGroupResults[groupIndex]);
                finalStandings.push(...resolvedBlock);
            } else {
                finalStandings.push(tiedPlayersBlock[0]);
            }
            i = j;
        }

        currentGroupStandings[groupIndex] = finalStandings;
    });
}

function resolveTie(tiedPlayers, groupIndex, allPlayersInGroup, groupResultsForThisGroup) {
    let miniStats = tiedPlayers.map(p => ({
        playerIndex: p.playerIndex,
        points: 0,
        setsWon: 0,
        setsLost: 0,
        playerName: p.playerName
    }));

    miniStats.forEach((p1Stat, m1Index) => {
        miniStats.forEach((p2Stat, m2Index) => {
            if (m1Index !== m2Index) {
                const originalP1Index = p1Stat.playerIndex;
                const originalP2Index = p2Stat.playerIndex;
                const result = groupResultsForThisGroup[originalP1Index][originalP2Index];
                if (result && result.includes(':')) {
                    const [setsWon, setsLost] = result.split(':').map(Number);
                    p1Stat.setsWon += setsWon;
                    p1Stat.setsLost += setsLost;
                    if (setsWon > setsLost) {
                        p1Stat.points += 3;
                    } else {
                        p1Stat.points += 1;
                    }
                }
            }
        });
    });

    miniStats.forEach(stat => {
        stat.setRatio = stat.setsLost > 0 ? (stat.setsWon / stat.setsLost) : (stat.setsWon > 0 ? Infinity : 0);
    });

    miniStats.sort((a, b) => {
        if (b.points !== a.points) return b.points - a.points;
        if (b.setRatio !== a.setRatio) return b.setRatio - a.setRatio;
        return 0;
    });

    const resolvedBlockOrdered = miniStats.map(ms => tiedPlayers.find(tp => tp.playerIndex === ms.playerIndex));

    if (resolvedBlockOrdered.length > 2) {
        resolvedBlockOrdered.sort((a, b) => {
            const miniA = miniStats.find(ms => ms.playerIndex === a.playerIndex);
            const miniB = miniStats.find(ms => ms.playerIndex === b.playerIndex);

            if (miniB.points !== miniA.points) return miniB.points - miniA.points;
            if (miniB.setRatio !== miniA.setRatio) return miniB.setRatio - miniA.setRatio;

            if (b.setRatio !== a.setRatio) return b.setRatio - a.setRatio;
            return a.playerIndex - b.playerIndex;
        });
    }

    return resolvedBlockOrdered;
}

function renderGroups() {
    console.log("renderGroups() called.");

    const mode = document.getElementById('mode').value;
    const currentGroupPlayers = mode === 'manual' ? manualGroupPlayers : groupPlayers;
    const currentGroupResults = mode === 'manual' ? manualGroupResults : groupResults;
    const currentGroupStandings = mode === 'manual' ? manualGroupStandings : groupStandings;

    const container = document.getElementById('groups-container');
    if (!container) {
        console.error("Error: groups-container element not found!");
        return;
    }
    container.innerHTML = '';
    calculateAllStandings();
    const numQualified = parseInt(document.getElementById(
        mode === 'manual' ? 'numQualifiedPlayersManual' : 'numQualifiedPlayers'
    ).value);
    console.log(`Number of qualified players per group: ${numQualified}`);

    if (currentGroupPlayers.length === 0) {
        console.warn("No groups to render. currentGroupPlayers is empty.");
        return;
    }

    currentGroupPlayers.forEach((players, groupIndex) => {
        console.log(`Processing Group ${groupIndex + 1} with ${players.length} players.`);

        const groupDiv = document.createElement('div');
        groupDiv.className = 'group-container';

        const groupTitle = document.createElement('h2');
        groupTitle.className = 'group-title';
        groupTitle.textContent = `${t('group')} ${groupIndex + 1}`;
        groupDiv.appendChild(groupTitle);

        const viewContainer = document.createElement('div');
        
        if (activeGroupView === 'table') {
            const tableContainer = document.createElement('div');
            tableContainer.className = 'table-container';
            const table = document.createElement('table');
            const headerRow = document.createElement('tr');
            headerRow.appendChild(createHeaderCell(t('players')));

            players.forEach((player, idx) => {
                headerRow.appendChild(createHeaderCell(`${idx + 1}. ${player}`));
            });

            headerRow.appendChild(createHeaderCell(t('points'), 'summary-header summary-punkty'));
            headerRow.appendChild(createHeaderCell(t('setBalance'), 'summary-header summary-bilans'));
            headerRow.appendChild(createHeaderCell(t('place'), 'summary-header summary-miejsce'));
            table.appendChild(headerRow);

            if (players.length > 0) {
                players.forEach((player, playerIndex) => {
                    const row = document.createElement('tr');
                    const standing = currentGroupStandings[groupIndex].find(s => s.playerIndex === playerIndex);
                    const position = currentGroupStandings[groupIndex].findIndex(s => s.playerIndex === playerIndex) + 1;

                    if (position <= numQualified) row.classList.add('qualified');

                    row.appendChild(createCell(`${playerIndex + 1}. ${player}`, 'player-header'));

                    players.forEach((opponent, opponentIndex) => {
                        const cell = document.createElement('td');

                        if (playerIndex === opponentIndex) {
                            cell.innerHTML = '<span class="bold-x">X</span>';
                        } else if (playerIndex < opponentIndex) {
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.className = 'score-input';
                            input.value = currentGroupResults[groupIndex][playerIndex][opponentIndex] || '';
                            input.placeholder = '0:0';
                            input.addEventListener('change', (e) => {
                                saveResult(groupIndex, playerIndex, opponentIndex, e.target.value, mode);
                                saveState();
                            });
                            cell.appendChild(input);
                        } else {
                            const result = currentGroupResults[groupIndex][playerIndex][opponentIndex];
                            cell.textContent = result || '';
                        }
                        row.appendChild(cell);
                    });

                    row.appendChild(createCell(standing.points, 'summary-punkty'));
                    let ratioText = "";
                    if (standing.setsLost === 0 && standing.setsWon > 0) {
                        ratioText = `${standing.setsWon}:0 ()`;
                    } else if (standing.setsWon === 0 && standing.setsLost === 0) {
                        ratioText = `0:0 (0.00)`;
                    } else {
                        ratioText = `${standing.setsWon}:${standing.setsLost} (${(standing.setRatio === Infinity ? "" : standing.setRatio.toFixed(2))})`;
                    }
                    row.appendChild(createCell(ratioText, 'summary-bilans'));
                    row.appendChild(createCell(position, 'summary-miejsce'));
                    table.appendChild(row);
                });
            }

            tableContainer.appendChild(table);
            viewContainer.appendChild(tableContainer);
        } else {
            const scheduleContainer = document.createElement('div');
            scheduleContainer.className = 'schedule-container active';
            renderGroupSchedule(groupIndex, players, currentGroupResults[groupIndex], scheduleContainer);
            viewContainer.appendChild(scheduleContainer);
        }

        groupDiv.appendChild(viewContainer);
        container.appendChild(groupDiv);
    });
}

function createHeaderCell(text, className = '') {
    const cell = document.createElement('th');
    cell.textContent = text;
    if (className) cell.className = className;
    return cell;
}

function createCell(text, className = '') {
    const cell = document.createElement('td');
    cell.textContent = text;
    if (className) cell.className = className;
    return cell;
}

function saveResult(groupIndex, playerIndex, opponentIndex, value, mode) {
    if (value && !/^\d+:\d+$/.test(value)) {
        alert(t('invalidScoreFormat'));
        return;
    }

    const currentGroupResults = mode === 'manual' ? manualGroupResults : groupResults;
    currentGroupResults[groupIndex][playerIndex][opponentIndex] = value;
    if (value) {
        const [a, b] = value.split(':').map(Number);
        currentGroupResults[groupIndex][opponentIndex][playerIndex] = `${b}:${a}`;
    } else {
        currentGroupResults[groupIndex][opponentIndex][playerIndex] = '';
    }
    renderGroups();
}

function generateBracket() {
    const bracketContainer = document.getElementById('knockout-bracket');
    if (!bracketContainer) return;
    
    bracketContainer.innerHTML = '';
    const mode = document.getElementById('mode').value;

    if (mode === 'manual') {
        manualPlayerColors = {};
    } else {
        autoPlayerColors = {};
    }

    const currentPlayerColors = mode === 'manual' ? manualPlayerColors : autoPlayerColors;
    const numQualified = parseInt(document.getElementById(
        mode === 'manual' ? 'numQualifiedPlayersManual' : 'numQualifiedPlayers'
    ).value);
    
    let allQualifiedPlayers = [];
    calculateAllStandings();

    let allPlayersWithStandings = [];
    const currentGroupPlayers = mode === 'manual' ? manualGroupPlayers : groupPlayers;
    const currentGroupStandings = mode === 'manual' ? manualGroupStandings : groupStandings;

    currentGroupStandings.forEach((group, groupIndex) => {
        group.forEach(standing => {
            allPlayersWithStandings.push({
                player: currentGroupPlayers[groupIndex][standing.playerIndex],
                points: standing.points,
                setRatio: standing.setRatio,
                originalGroupIndex: groupIndex,
                originalPlayerIndex: standing.playerIndex
            });
        });
    });

    allPlayersWithStandings.sort((a, b) => {
        if (b.points !== a.points) return b.points - a.points;
        if (b.setRatio !== a.setRatio) return b.setRatio - a.setRatio;
        if (a.originalGroupIndex !== b.originalGroupIndex) return a.originalGroupIndex - b.originalGroupIndex;
        return a.originalPlayerIndex - b.originalPlayerIndex;
    });

    let playersConsideredForBracket = [];
    currentGroupStandings.forEach((group, groupIndex) => {
        for(let i = 0; i < Math.min(numQualified, group.length); i++) {
            playersConsideredForBracket.push(currentGroupPlayers[groupIndex][group[i].playerIndex]);
        }
    });

    allQualifiedPlayers = playersConsideredForBracket;

    if (allQualifiedPlayers.length === 0) {
        alert(t('noQualifiedPlayers'));
        return;
    }

    while (allQualifiedPlayers.length < 8) {
        allQualifiedPlayers.push("WOLNY LOS");
    }
    if (allQualifiedPlayers.length > 8) {
        allQualifiedPlayers = allQualifiedPlayers.slice(0, 8);
        alert(t('tooManyPlayers'));
    }

    const seededPlayers = new Array(8);
    seededPlayers[0] = allQualifiedPlayers[0];
    seededPlayers[1] = allQualifiedPlayers[7];
    seededPlayers[2] = allQualifiedPlayers[4];
    seededPlayers[3] = allQualifiedPlayers[3];
    seededPlayers[4] = allQualifiedPlayers[5];
    seededPlayers[5] = allQualifiedPlayers[2];
    seededPlayers[6] = allQualifiedPlayers[6];
    seededPlayers[7] = allQualifiedPlayers[1];

    const bracketParticipants = [
        seededPlayers[0], seededPlayers[1],
        seededPlayers[2], seededPlayers[3],
        seededPlayers[4], seededPlayers[5],
        seededPlayers[6], seededPlayers[7]
    ];

    const actualParticipants = bracketParticipants.filter(p => p !== "WOLNY LOS");
    const colorClasses = [
        'player-color-1', 'player-color-2', 'player-color-3', 'player-color-4',
        'player-color-5', 'player-color-6', 'player-color-7', 'player-color-8'
    ];

    actualParticipants.forEach((player, index) => {
        currentPlayerColors[player] = colorClasses[index % colorClasses.length];
    });

    const currentKnockoutMatches = mode === 'manual' ? manualKnockoutMatches : autoKnockoutMatches;
    const currentConsolationMatches = mode === 'manual' ? manualConsolationMatches : autoConsolationMatches;

    currentConsolationMatches.semifinals = [];
    currentConsolationMatches.fifthPlace = null;
    currentConsolationMatches.seventhPlace = null;

    currentKnockoutMatches.quarterfinals = [
        { id: 'qf1', player1: bracketParticipants[0], player2: bracketParticipants[1], score1: '', score2: '', winner: null, loser: null },
        { id: 'qf2', player1: bracketParticipants[2], player2: bracketParticipants[3], score1: '', score2: '', winner: null, loser: null },
        { id: 'qf3', player1: bracketParticipants[4], player2: bracketParticipants[5], score1: '', score2: '', winner: null, loser: null },
        { id: 'qf4', player1: bracketParticipants[6], player2: bracketParticipants[7], score1: '', score2: '', winner: null, loser: null }
    ];
    currentKnockoutMatches.semifinals = [
        { id: 'sf1', player1: null, player2: null, score1: '', score2: '', winner: null, loser: null },
        { id: 'sf2', player1: null, player2: null, score1: '', score2: '', winner: null, loser: null }
    ];
    currentKnockoutMatches.final = { id: 'final', player1: null, player2: null, score1: '', score2: '', winner: null, loser: null };
    currentKnockoutMatches.thirdPlace = { id: 'third', player1: null, player2: null, score1: '', score2: '', winner: null, loser: null };

    displayBracket();
    handleByes();
    updateClassification();
}

function displayBracket() {
    console.log("displayBracket() called.");
    const bracketContainer = document.getElementById('knockout-bracket');
    if (!bracketContainer) return;

    const mode = document.getElementById('mode').value;
    const currentKnockoutMatches = mode === 'manual' ? manualKnockoutMatches : autoKnockoutMatches;

    if (!currentKnockoutMatches.quarterfinals || currentKnockoutMatches.quarterfinals.length === 0 ||
        !currentKnockoutMatches.quarterfinals.some(m => m.player1)) {
        bracketContainer.innerHTML = '';
        return;
    }

    bracketContainer.innerHTML = '';
    const bracketWrapper = document.createElement('div');
    bracketWrapper.className = 'bracket';

    const quartersColumn = document.createElement('div');
    quartersColumn.className = 'bracket-column';
    const quartersTitle = document.createElement('h3');
    quartersTitle.className = 'round-title';
    quartersTitle.textContent = t('quarterfinals');
    quartersColumn.appendChild(quartersTitle);
    currentKnockoutMatches.quarterfinals.forEach(match => {
        quartersColumn.appendChild(createMatchElement(match, 'main'));
    });
    bracketWrapper.appendChild(quartersColumn);

    const semisColumn = document.createElement('div');
    semisColumn.className = 'bracket-column';
    const semisTitle = document.createElement('h3');
    semisTitle.className = 'round-title';
    semisTitle.textContent = t('semifinals');
    semisColumn.appendChild(semisTitle);
    currentKnockoutMatches.semifinals.forEach(match => {
        semisColumn.appendChild(createMatchElement(match, 'main'));
    });
    
    const thirdPlaceTitle = document.createElement('h3');
    thirdPlaceTitle.className = 'round-title';
    thirdPlaceTitle.textContent = t('thirdPlace');
    semisColumn.appendChild(thirdPlaceTitle);
    if (currentKnockoutMatches.thirdPlace) {
        semisColumn.appendChild(createMatchElement(currentKnockoutMatches.thirdPlace, 'main'));
    }
    bracketWrapper.appendChild(semisColumn);

    const finalColumn = document.createElement('div');
    finalColumn.className = 'bracket-column';
    const finalTitle = document.createElement('h3');
    finalTitle.className = 'round-title';
    finalTitle.textContent = t('final');
    finalColumn.appendChild(finalTitle);
    if (currentKnockoutMatches.final) {
        finalColumn.appendChild(createMatchElement(currentKnockoutMatches.final, 'main'));
    }

    const classificationTitle = document.createElement('h3');
    classificationTitle.className = 'round-title';
    classificationTitle.textContent = t('finalClassification');
    finalColumn.appendChild(classificationTitle);

    for (let i = 1; i <= 8; i++) {
        const box = document.createElement('div');
        box.className = 'classification-box';
        box.id = `classification-place-${i}`;
        box.innerHTML = `<span class="classification-place">${i}.</span><span class="player-name">?</span>`;
        finalColumn.appendChild(box);
    }
    bracketWrapper.appendChild(finalColumn);
    bracketContainer.appendChild(bracketWrapper);
}

function createMatchElement(match, type = 'main') {
    const mode = document.getElementById('mode').value;
    const currentPlayerColors = mode === 'manual' ? manualPlayerColors : autoPlayerColors;
    let matchDiv;

    matchDiv = document.createElement('div');
    matchDiv.className = 'bracket-match';

    if (match.id === 'final' || (type === 'consolation' && match.id === 'fifth')) {
        matchDiv.classList.add('final-match');
    } else if (match.id === 'third' || (type === 'consolation' && match.id === 'seventh')) {
        matchDiv.classList.add('third-place-match');
    }

    matchDiv.dataset.id = match.id;
    matchDiv.dataset.type = type;

    const player1Row = document.createElement('div');
    player1Row.className = 'bracket-player';
    if (match.player1 && currentPlayerColors[match.player1]) {
        player1Row.classList.add(currentPlayerColors[match.player1]);
    }

    const player1Name = document.createElement('span');
    player1Name.className = 'player-name';
    player1Name.textContent = match.player1 || "?";

    const scoreInput1 = document.createElement('input');
    scoreInput1.type = 'text';
    scoreInput1.className = 'score-input';
    scoreInput1.placeholder = '0';
    scoreInput1.dataset.player = '1';
    scoreInput1.value = match.score1;
    scoreInput1.addEventListener('blur', function() {
        if (type === 'main') {
            updateMatchResult(match, this);
        } else {
            updateConsolationMatchResult(match, this);
        }
        saveState();
    });

    player1Row.appendChild(player1Name);
    player1Row.appendChild(scoreInput1);

    const player2Row = document.createElement('div');
    player2Row.className = 'bracket-player';
    if (match.player2 && currentPlayerColors[match.player2]) {
        player2Row.classList.add(currentPlayerColors[match.player2]);
    }

    const player2Name = document.createElement('span');
    player2Name.className = 'player-name';
    player2Name.textContent = match.player2 || "?";

    const scoreInput2 = document.createElement('input');
    scoreInput2.type = 'text';
    scoreInput2.className = 'score-input';
    scoreInput2.placeholder = '0';
    scoreInput2.dataset.player = '2';
    scoreInput2.value = match.score2;
    scoreInput2.addEventListener('blur', function() {
        if (type === 'main') {
            updateMatchResult(match, this);
        } else {
            updateConsolationMatchResult(match, this);
        }
        saveState();
    });

    player2Row.appendChild(player2Name);
    player2Row.appendChild(scoreInput2);

    matchDiv.appendChild(player1Row);
    matchDiv.appendChild(player2Row);

    return matchDiv;
}

function updateMatchResult(match, inputElement) {
    console.log(`updateMatchResult() called for match ID: ${match.id}`);
    const matchDiv = document.querySelector(`.bracket-match[data-id="${match.id}"]`);
    if (!matchDiv) {
        console.error(`Error: Match div not found for ID: ${match.id}`);
        return;
    }
    
    const scoreInput1 = matchDiv.querySelector('.score-input[data-player="1"]');
    const scoreInput2 = matchDiv.querySelector('.score-input[data-player="2"]');

    const score1 = scoreInput1.value.trim();
    const score2 = scoreInput2.value.trim();

    match.score1 = score1;
    match.score2 = score2;
    console.log(`Match ${match.id} scores: ${score1}:${score2}`);

    if (score1 && score2) {
        if (parseInt(score1) > parseInt(score2)) {
            match.winner = match.player1;
            match.loser = match.player2;
        } else {
            match.winner = match.player2;
            match.loser = match.player1;
        }
        console.log(`Match ${match.id} winner: ${match.winner}, loser: ${match.loser}`);
        updateNextRounds(match);
    }

    updateClassification();
    console.log("updateMatchResult() finished.");
}

function updateNextRounds(match) {
    const nextMatchInfo = nextMatchMap[match.id];
    if (!nextMatchInfo) return;

    const mode = document.getElementById('mode').value;
    const currentKnockoutMatches = mode === 'manual' ? manualKnockoutMatches : autoKnockoutMatches;
    const currentConsolationMatches = mode === 'manual' ? manualConsolationMatches : autoConsolationMatches;
    const currentPlayerColors = mode === 'manual' ? manualPlayerColors : autoPlayerColors;

    let nextMatchForWinner;
    let nextMatchForLoser;

    if (match.id.startsWith('qf')) {
        nextMatchForWinner = currentKnockoutMatches[nextMatchInfo.nextRound][nextMatchInfo.nextMatchIndex];
    } else if (match.id.startsWith('sf')) {
        nextMatchForWinner = currentKnockoutMatches.final;
        nextMatchForLoser = currentKnockoutMatches.thirdPlace;
    }

    if (nextMatchForWinner) {
        if (nextMatchInfo.nextPlayer === 1) {
            nextMatchForWinner.player1 = match.winner;
        } else {
            nextMatchForWinner.player2 = match.winner;
        }
        const nextMatchDiv = document.querySelector(`.bracket-match[data-id="${nextMatchForWinner.id}"]`);
        if (nextMatchDiv) {
            const playerRow = nextMatchDiv.querySelector(
                nextMatchInfo.nextPlayer === 1
                    ? '.bracket-player:first-child'
                    : '.bracket-player:last-child'
            );
            if (playerRow) {
                playerRow.querySelector('.player-name').textContent = match.winner;
                playerRow.className = 'bracket-player ' + (currentPlayerColors[match.winner] || '');
            }
        }
        if (nextMatchForWinner.player1 && nextMatchForWinner.player2 && (nextMatchForWinner.player1 === "WOLNY LOS" || nextMatchForWinner.player2 === "WOLNY LOS")) {
            const isWinnerPlayer1Bye = nextMatchForWinner.player1 === "WOLNY LOS";
            const winnerResult = isWinnerPlayer1Bye ? nextMatchForWinner.player2 : nextMatchForWinner.player1;
            nextMatchForWinner.score1 = isWinnerPlayer1Bye ? '0' : '3';
            nextMatchForWinner.score2 = isWinnerPlayer1Bye ? '3' : '0';
            nextMatchForWinner.winner = winnerResult;
            nextMatchForWinner.loser = isWinnerPlayer1Bye ? nextMatchForWinner.player1 : nextMatchForWinner.player2;

            if (nextMatchDiv) {
                const nextMatchInput1 = nextMatchDiv.querySelector('.score-input[data-player="1"]');
                const nextMatchInput2 = nextMatchDiv.querySelector('.score-input[data-player="2"]');
                if (nextMatchInput1) nextMatchInput1.value = nextMatchForWinner.score1;
                if (nextMatchInput2) nextMatchInput2.value = nextMatchForWinner.score2;
                if (nextMatchInput1) nextMatchInput1.disabled = true;
                if (nextMatchInput2) nextMatchInput2.disabled = true;
            }
            if (nextMatchForWinner.id !== 'final' && nextMatchForWinner.id !== 'third') {
                updateNextRounds(nextMatchForWinner);
            }
        }
    }

    if (nextMatchForLoser && match.loser) {
        if (nextMatchInfo.loserPlayerPos === 1) {
            nextMatchForLoser.player1 = match.loser;
        } else {
            nextMatchForLoser.player2 = match.loser;
        }
        const loserMatchDiv = document.querySelector(`.bracket-match[data-id="${nextMatchForLoser.id}"]`);
        if (loserMatchDiv) {
            const playerRow = loserMatchDiv.querySelector(
                nextMatchInfo.loserPlayerPos === 1
                    ? '.bracket-player:first-child'
                    : '.bracket-player:last-child'
            );
            if (playerRow) {
                playerRow.querySelector('.player-name').textContent = match.loser;
                playerRow.className = 'bracket-player ' + (currentPlayerColors[match.loser] || '');
            }
        }
        if (nextMatchForLoser.player1 && nextMatchForLoser.player2 && (nextMatchForLoser.player1 === "WOLNY LOS" || nextMatchForLoser.player2 === "WOLNY LOS")) {
            const isThirdPlayer1Bye = nextMatchForLoser.player1 === "WOLNY LOS";
            const thirdWinner = isThirdPlayer1Bye ? nextMatchForLoser.player2 : nextMatchForLoser.player1;
            nextMatchForLoser.score1 = isThirdPlayer1Bye ? '0' : '3';
            nextMatchForLoser.score2 = isThirdPlayer1Bye ? '3' : '0';
            nextMatchForLoser.winner = thirdWinner;
            nextMatchForLoser.loser = isThirdPlayer1Bye ? nextMatchForLoser.player1 : nextMatchForLoser.player2;

            if (loserMatchDiv) {
                const thirdMatchInput1 = loserMatchDiv.querySelector('.score-input[data-player="1"]');
                const thirdMatchInput2 = loserMatchDiv.querySelector('.score-input[data-player="2"]');
                if (thirdMatchInput1) thirdMatchInput1.value = nextMatchForLoser.score1;
                if (thirdMatchInput2) thirdMatchInput2.value = nextMatchForLoser.score2;
                if (thirdMatchInput1) thirdMatchInput1.disabled = true;
                if (thirdMatchInput2) thirdMatchInput2.disabled = true;
            }
        }
    }

    if (nextMatchInfo.loserToConsolation && match.loser) {
        const consolationMatchInfo = nextMatchMap[match.id];
        if (consolationMatchInfo.loserConsolationMatch) {
            const targetConsolationMatch = currentConsolationMatches.semifinals.find(m => m.id === consolationMatchInfo.loserConsolationMatch);
            if (targetConsolationMatch) {
                if (consolationMatchInfo.loserConsolationPlayer === 1) {
                    targetConsolationMatch.player1 = match.loser;
                } else {
                    targetConsolationMatch.player2 = match.loser;
                }
                const consMatchDiv = document.querySelector(`.bracket-match[data-id="${targetConsolationMatch.id}"][data-type="consolation"]`);
                if (consMatchDiv) {
                    const consPlayerRow = consMatchDiv.querySelector(
                        consolationMatchInfo.loserConsolationPlayer === 1
                            ? '.bracket-player:first-child'
                            : '.bracket-player:last-child'
                    );
                    if (consPlayerRow) {
                        consPlayerRow.querySelector('.player-name').textContent = match.loser;
                        consPlayerRow.className = 'bracket-player ' + (currentPlayerColors[match.loser] || '');
                    }
                }
                if (targetConsolationMatch.player1 && targetConsolationMatch.player2 && (targetConsolationMatch.player1 === "WOLNY LOS" || targetConsolationMatch.player2 === "WOLNY LOS")) {
                    const isConsolationPlayer1Bye = targetConsolationMatch.player1 === "WOLNY LOS";
                    const consWinner = isConsolationPlayer1Bye ? targetConsolationMatch.player2 : targetConsolationMatch.player1;
                    targetConsolationMatch.score1 = isConsolationPlayer1Bye ? '0' : '3';
                    targetConsolationMatch.score2 = isConsolationPlayer1Bye ? '3' : '0';
                    targetConsolationMatch.winner = consWinner;
                    targetConsolationMatch.loser = isConsolationPlayer1Bye ? targetConsolationMatch.player1 : targetConsolationMatch.player2;

                    if (consMatchDiv) {
                        const consInput1 = consMatchDiv.querySelector('.score-input[data-player="1"]');
                        const consInput2 = consMatchDiv.querySelector('.score-input[data-player="2"]');
                        if (consInput1) consInput1.value = targetConsolationMatch.score1;
                        if (consInput2) consInput2.value = targetConsolationMatch.score2;
                        if (consInput1) consInput1.disabled = true;
                        if (consInput2) consInput2.disabled = true;
                    }
                    updateNextConsolationRounds(targetConsolationMatch);
                }
            }
        }
    }
    saveState();
}

function updateClassification() {
    const mode = document.getElementById('mode').value;
    const currentKnockoutMatches = mode === 'manual' ? manualKnockoutMatches : autoKnockoutMatches;
    const currentConsolationMatches = mode === 'manual' ? manualConsolationMatches : autoConsolationMatches;
    const currentPlayerColors = mode === 'manual' ? manualPlayerColors : autoPlayerColors;

    const final = currentKnockoutMatches.final;
    const third = currentKnockoutMatches.thirdPlace;

    for (let i = 1; i <= 8; i++) {
        setClassificationBox(i, null);
    }

    let firstPlace = null;
    let secondPlace = null;
    let thirdPlace = null;
    let fourthPlace = null;

    if (final && final.winner) {
        firstPlace = final.winner;
        secondPlace = final.loser;
    }
    if (third && third.winner) {
        thirdPlace = third.winner;
        fourthPlace = third.loser;
    }

    setClassificationBox(1, firstPlace);
    setClassificationBox(2, secondPlace);
    setClassificationBox(3, thirdPlace);
    setClassificationBox(4, fourthPlace);

    const consolationMode = document.getElementById('consolationMode').value;
    updateConsolationClassification(consolationMode === 'yes');
}

function setClassificationBox(place, player) {
    let box = document.getElementById(`classification-place-${place}`);

    if (!box) {
        const mainFinalColumn = document.querySelector('#knockout-bracket .bracket-column:last-child');
        if (mainFinalColumn) {
            const newBox = document.createElement('div');
            newBox.className = 'classification-box';
            newBox.id = `classification-place-${place}`;
            newBox.innerHTML = `<span class="classification-place">${place}.</span><span class="player-name">?</span>`;
            mainFinalColumn.appendChild(newBox);
            box = newBox;
        } else {
            return;
        }
    }

    const span = box.querySelector('.player-name');
    if (!span) return;
    
    span.textContent = (player && player !== "WOLNY LOS") ? player : '?';
    box.className = 'classification-box';

    const mode = document.getElementById('mode').value;
    const currentPlayerColors = mode === 'manual' ? manualPlayerColors : autoPlayerColors;

    if (currentPlayerColors[player]) {
        box.classList.add(currentPlayerColors[player]);
    }
    if (place >= 5 && place <= 8) {
        const consolationMode = document.getElementById('consolationMode').value;
        box.style.display = consolationMode === 'yes' ? '' : 'none';
    } else {
        box.style.display = '';
    }
}

function handleByes() {
    const mode = document.getElementById('mode').value;
    const currentKnockoutMatches = mode === 'manual' ? manualKnockoutMatches : autoKnockoutMatches;

    document.querySelectorAll('.bracket-match[data-type="main"]').forEach(matchDiv => {
        const matchId = matchDiv.dataset.id;
        const match = findMatchById(matchId, 'main');
        if (!match) return;
        if ((match.player1 === "WOLNY LOS" && match.player2) || (match.player2 === "WOLNY LOS" && match.player1)) {
            const isPlayer1Bye = match.player1 === "WOLNY LOS";
            const winner = isPlayer1Bye ? match.player2 : match.player1;
            const loser = isPlayer1Bye ? match.player1 : match.player2;
            match.score1 = isPlayer1Bye ? '0' : '3';
            match.score2 = isPlayer1Bye ? '3' : '0';
            match.winner = winner;
            match.loser = loser;

            const input1 = matchDiv.querySelector('.score-input[data-player="1"]');
            const input2 = matchDiv.querySelector('.score-input[data-player="2"]');
            if (input1 && input2) {
                input1.value = match.score1;
                input2.value = match.score2;
                input1.disabled = true;
                input2.disabled = true;
            }
            updateNextRounds(match);
        }
    });
}

function findMatchById(id, type = 'main') {
    const mode = document.getElementById('mode').value;
    const currentKnockoutMatches = mode === 'manual' ? manualKnockoutMatches : autoKnockoutMatches;
    const currentConsolationMatches = mode === 'manual' ? manualConsolationMatches : autoConsolationMatches;

    if (type === 'main') {
        for (const match of currentKnockoutMatches.quarterfinals) {
            if (match.id === id) return match;
        }
        for (const match of currentKnockoutMatches.semifinals) {
            if (match.id === id) return match;
        }
        if (currentKnockoutMatches.final && currentKnockoutMatches.final.id === id) return currentKnockoutMatches.final;
        if (currentKnockoutMatches.thirdPlace && currentKnockoutMatches.thirdPlace.id === id) return currentKnockoutMatches.thirdPlace;
    } else {
        for (const match of currentConsolationMatches.semifinals) {
            if (match.id === id) return match;
        }
        if (currentConsolationMatches.fifthPlace && currentConsolationMatches.fifthPlace.id === id) return currentConsolationMatches.fifthPlace;
        if (currentConsolationMatches.seventhPlace && currentConsolationMatches.seventhPlace.id === id) return currentConsolationMatches.seventhPlace;
    }
    return null;
}

function toggleConsolationVisibility() {
    const consolationMode = document.getElementById('consolationMode').value;
    if (consolationMode === 'yes') {
        document.getElementById('consolationSection').style.display = 'block';
    } else {
        document.getElementById('consolationSection').style.display = 'none';
    }
    updateClassification();
    saveState();
}

function generateConsolationBracket() {
    const bracketContainer = document.getElementById('consolation-bracket');
    if (!bracketContainer) return;
    
    bracketContainer.innerHTML = '';
    const consolationMode = document.getElementById('consolationMode').value;
    
    if (consolationMode !== 'yes') {
        alert(t('enableConsolationFirst'));
        return;
    }

    const mode = document.getElementById('mode').value;
    const currentKnockoutMatches = mode === 'manual' ? manualKnockoutMatches : autoKnockoutMatches;
    const currentConsolationMatches = mode === 'manual' ? manualConsolationMatches : autoConsolationMatches;
    const currentPlayerColors = mode === 'manual' ? manualPlayerColors : autoPlayerColors;

    const qfLosers = [];
    currentKnockoutMatches.quarterfinals.forEach(match => {
        if (match.loser && match.loser !== "WOLNY LOS") {
            qfLosers.push(match.loser);
        }
    });

    if (qfLosers.length < 4) {
        alert(t('notEnoughLosers'));
        return;
    }

    const consolationParticipants = qfLosers.slice(0, 4);
    const allPlayers = Object.keys(currentPlayerColors);
    
    if (allPlayers.length < 8) {
        const availableColors = [
            'player-color-1', 'player-color-2', 'player-color-3', 'player-color-4',
            'player-color-5', 'player-color-6', 'player-color-7', 'player-color-8'
        ];
        let colorIndex = 0;
        consolationParticipants.forEach(player => {
            if (!currentPlayerColors[player]) {
                while (Object.values(currentPlayerColors).includes(availableColors[colorIndex])) {
                    colorIndex = (colorIndex + 1) % availableColors.length;
                }
                currentPlayerColors[player] = availableColors[colorIndex];
                colorIndex = (colorIndex + 1) % availableColors.length;
            }
        });
    }

    currentConsolationMatches.semifinals = [
        { id: 'csf1', player1: consolationParticipants[0], player2: consolationParticipants[1], score1: '', score2: '', winner: null, loser: null },
        { id: 'csf2', player1: consolationParticipants[2], player2: consolationParticipants[3], score1: '', score2: '', winner: null, loser: null }
    ];
    currentConsolationMatches.fifthPlace = { id: 'fifth', player1: null, player2: null, score1: '', score2: '', winner: null, loser: null };
    currentConsolationMatches.seventhPlace = { id: 'seventh', player1: null, player2: null, score1: '', score2: '', winner: null, loser: null };

    displayConsolationBracket();
    updateConsolationClassification(true);
}

function displayConsolationBracket() {
    const bracketContainer = document.getElementById('consolation-bracket');
    if (!bracketContainer) return;

    const mode = document.getElementById('mode').value;
    const currentConsolationMatches = mode === 'manual' ? manualConsolationMatches : autoConsolationMatches;

    if (!currentConsolationMatches.semifinals || currentConsolationMatches.semifinals.length === 0 ||
        !currentConsolationMatches.semifinals.some(m => m.player1)) {
        bracketContainer.innerHTML = '';
        return;
    }

    bracketContainer.innerHTML = '';
    const bracketWrapper = document.createElement('div');
    bracketWrapper.className = 'bracket';

    const semisColumn = document.createElement('div');
    semisColumn.className = 'bracket-column';
    const semisTitle = document.createElement('h3');
    semisTitle.className = 'round-title';
    semisTitle.textContent = t('consolationSemifinals');
    semisColumn.appendChild(semisTitle);
    currentConsolationMatches.semifinals.forEach(match => {
        semisColumn.appendChild(createMatchElement(match, 'consolation'));
    });
    bracketWrapper.appendChild(semisColumn);

    const matchesColumn = document.createElement('div');
    matchesColumn.className = 'bracket-column';
    const fifthPlaceTitle = document.createElement('h3');
    fifthPlaceTitle.className = 'round-title';
    fifthPlaceTitle.textContent = t('fifthPlace');
    matchesColumn.appendChild(fifthPlaceTitle);
    if (currentConsolationMatches.fifthPlace) {
        matchesColumn.appendChild(createMatchElement(currentConsolationMatches.fifthPlace, 'consolation'));
    }
    const seventhPlaceTitle = document.createElement('h3');
    seventhPlaceTitle.className = 'round-title';
    seventhPlaceTitle.textContent = t('seventhPlace');
    matchesColumn.appendChild(seventhPlaceTitle);
    if (currentConsolationMatches.seventhPlace) {
        matchesColumn.appendChild(createMatchElement(currentConsolationMatches.seventhPlace, 'consolation'));
    }
    bracketWrapper.appendChild(matchesColumn);

    const classificationColumn = document.createElement('div');
    classificationColumn.className = 'bracket-column';
    const classificationTitle = document.createElement('h3');
    classificationTitle.className = 'round-title';
    classificationTitle.textContent = t('consolationClassification');
    classificationColumn.appendChild(classificationTitle);

    for (let i = 5; i <= 8; i++) {
        const box = document.createElement('div');
        box.className = 'classification-box';
        box.id = `consolation-classification-place-${i}`;
        box.innerHTML = `<span class="classification-place">${i}.</span><span class="player-name">?</span>`;
        classificationColumn.appendChild(box);
    }

    bracketWrapper.appendChild(classificationColumn);
    bracketContainer.appendChild(bracketWrapper);
}

function updateConsolationMatchResult(match, inputElement) {
    const matchDiv = document.querySelector(`.bracket-match[data-id="${match.id}"][data-type="consolation"]`);
    if (!matchDiv) return;
    
    const scoreInput1 = matchDiv.querySelector('.score-input[data-player="1"]');
    const scoreInput2 = matchDiv.querySelector('.score-input[data-player="2"]');
    const score1 = scoreInput1.value.trim();
    const score2 = scoreInput2.value.trim();

    match.score1 = score1;
    match.score2 = score2;

    if (score1 && score2) {
        if (parseInt(score1) > parseInt(score2)) {
            match.winner = match.player1;
            match.loser = match.player2;
        } else {
            match.winner = match.player2;
            match.loser = match.player1;
        }
        updateNextConsolationRounds(match);
    }
    updateConsolationClassification(true);
    saveState();
}

function updateNextConsolationRounds(match) {
    const nextMatchInfo = nextConsolationMatchMap[match.id];
    if (!nextMatchInfo) return;

    const mode = document.getElementById('mode').value;
    const currentConsolationMatches = mode === 'manual' ? manualConsolationMatches : autoConsolationMatches;
    const currentPlayerColors = mode === 'manual' ? manualPlayerColors : autoPlayerColors;

    let nextMatchForWinner = currentConsolationMatches.fifthPlace;
    if (nextMatchForWinner) {
        if (nextMatchInfo.winnerPlayerPos === 1) {
            nextMatchForWinner.player1 = match.winner;
        } else {
            nextMatchForWinner.player2 = match.winner;
        }
        const nextMatchDiv = document.querySelector(`.bracket-match[data-id="${nextMatchForWinner.id}"][data-type="consolation"]`);
        if (nextMatchDiv) {
            const playerRow = nextMatchDiv.querySelector(
                nextMatchInfo.winnerPlayerPos === 1
                    ? '.bracket-player:first-child'
                    : '.bracket-player:last-child'
            );
            if (playerRow) {
                playerRow.querySelector('.player-name').textContent = match.winner;
                playerRow.className = 'bracket-player ' + (currentPlayerColors[match.winner] || '');
            }
        }
    }

    let nextMatchForLoser = currentConsolationMatches.seventhPlace;
    if (nextMatchForLoser) {
        if (nextMatchInfo.loserPlayerPos === 1) {
            nextMatchForLoser.player1 = match.loser;
        } else {
            nextMatchForLoser.player2 = match.loser;
        }
        const nextMatchDiv = document.querySelector(`.bracket-match[data-id="${nextMatchForLoser.id}"][data-type="consolation"]`);
        if (nextMatchDiv) {
            const playerRow = nextMatchDiv.querySelector(
                nextMatchInfo.loserPlayerPos === 1
                    ? '.bracket-player:first-child'
                    : '.bracket-player:last-child'
            );
            if (playerRow) {
                playerRow.querySelector('.player-name').textContent = match.loser;
                playerRow.className = 'bracket-player ' + (currentPlayerColors[match.loser] || '');
            }
        }
    }
}

function setConsolationClassificationBox(place, player) {
    const boxId = `consolation-classification-place-${place}`;
    const box = document.getElementById(boxId);
    if (!box) return;

    const span = box.querySelector('.player-name');
    if (span) {
        span.textContent = (player && player !== "WOLNY LOS") ? player : '?';
    }

    box.className = 'classification-box';

    const mode = document.getElementById('mode').value;
    const currentPlayerColors = mode === 'manual' ? manualPlayerColors : autoPlayerColors;

    if (currentPlayerColors[player]) {
        box.classList.add(currentPlayerColors[player]);
    }
}

function updateConsolationClassification(isActive) {
    const mode = document.getElementById('mode').value;
    const currentConsolationMatches = mode === 'manual' ? manualConsolationMatches : autoConsolationMatches;

    const fifth = currentConsolationMatches.fifthPlace;
    const seventh = currentConsolationMatches.seventhPlace;

    let fifthPlace = null;
    let sixthPlace = null;
    let seventhPlace = null;
    let eighthPlace = null;

    if (fifth && fifth.winner) {
        fifthPlace = fifth.winner;
        sixthPlace = fifth.loser;
    }
    if (seventh && seventh.winner) {
        seventhPlace = seventh.winner;
        eighthPlace = seventh.loser;
    }

    setClassificationBox(5, fifthPlace);
    setClassificationBox(6, sixthPlace);
    setClassificationBox(7, seventhPlace);
    setClassificationBox(8, eighthPlace);

    if (isActive) {
        setConsolationClassificationBox(5, fifthPlace);
        setConsolationClassificationBox(6, sixthPlace);
        setConsolationClassificationBox(7, seventhPlace);
        setConsolationClassificationBox(8, eighthPlace);
    }
}

function toggleCollapse(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    const button = container.querySelector('.collapse-button');
    const content = container.querySelector('.collapsible-content');

    if (container.classList.contains('collapsed')) {
        container.classList.remove('collapsed');
        if (button) button.textContent = t('collapse');
        if (content) {
            content.style.maxHeight = content.scrollHeight + 'px';
            content.addEventListener('transitionend', function handler() {
                if (!container.classList.contains('collapsed')) {
                    content.style.maxHeight = '';
                }
                content.removeEventListener('transitionend', handler);
            }, { once: true });
        }
    } else {
        if (content) {
            content.style.maxHeight = content.scrollHeight + 'px';
            void content.offsetWidth;
            content.style.maxHeight = '0';
        }
        container.classList.add('collapsed');
        if (button) button.textContent = t('expand');
    }
    saveState();
}

function getLocalStorageKey(categoryName) {
    const sanitizedName = categoryName.trim().toLowerCase().replace(/[^a-z0-9]+/g, '_');
    return `tournamentData_${sanitizedName || 'default'}`;
}

function saveState() {
    if (!shouldSave) {
        return;
    }

    const currentCat = document.getElementById('subTitleInput').value;
    const currentName = document.getElementById('tournamentNameInput').value;
    
    if (currentCat) localStorage.setItem('LAST_OPEN_CATEGORY', currentCat);
    if (currentName) localStorage.setItem('LAST_TOURNAMENT_NAME', currentName);

    const categoryName = document.getElementById('subTitleInput').value;
    const storageKey = getLocalStorageKey(categoryName);

    const dataToSave = {
        tournamentName: document.getElementById('tournamentNameInput').value,
        
        autoSubTitle: autoSubTitle,
        manualSubTitle: manualSubTitle,
        playersAutoInput: document.getElementById('playersAuto').value,
        playersManualInput: document.getElementById('playersManual').value,
        mode: document.getElementById('mode').value,
        consolationMode: document.getElementById('consolationMode').value,
        numGroupsAuto: document.getElementById('numGroupsAuto').value,
        numQualifiedPlayers: document.getElementById('numQualifiedPlayers').value,
        numGroupsManual: document.getElementById('numGroupsManual').value,
        manualGroupPlayersText: [],
        groupPlayers: groupPlayers,
        groupResults: groupResults,
        groupStandings: groupStandings,
        manualGroupPlayers: manualGroupPlayers,
        manualGroupResults: manualGroupResults,
        manualGroupStandings: manualGroupStandings,
        autoKnockoutMatches: autoKnockoutMatches,
        manualKnockoutMatches: manualKnockoutMatches,
        autoConsolationMatches: autoConsolationMatches,
        manualConsolationMatches: manualConsolationMatches,
        autoPlayerColors: autoPlayerColors,
        manualPlayerColors: manualPlayerColors,
        controlPanelCollapsed: document.getElementById('controlPanel').classList.contains('collapsed'),
        groupSectionCollapsed: document.getElementById('groupSection').classList.contains('collapsed'),
        knockoutSectionCollapsed: document.getElementById('knockoutSection').classList.contains('collapsed'),
        consolationSectionCollapsed: document.getElementById('consolationSection').classList.contains('collapsed'),
        activeGroupView: activeGroupView,
        currentLanguage: currentLanguage
    };

    const manualGroupCount = parseInt(document.getElementById('numGroupsManual').value);
    for (let i = 0; i < manualGroupCount; i++) {
        const elem = document.getElementById(`manual-group-${i}`);
        if (elem) {
            dataToSave.manualGroupPlayersText.push(elem.value);
        } else {
            dataToSave.manualGroupPlayersText.push('');
        }
    }

    try {
        localStorage.setItem(storageKey, JSON.stringify(dataToSave));
    } catch (e) {
    }
}

function loadState() {
    let catInput = document.getElementById('subTitleInput');
    let nameInput = document.getElementById('tournamentNameInput');
    
    if (!catInput.value) {
        const lastCat = localStorage.getItem('LAST_OPEN_CATEGORY');
        if (lastCat) {
            catInput.value = lastCat;
            if (document.getElementById('mode').value === 'manual') manualSubTitle = lastCat;
            else autoSubTitle = lastCat;
        }
    }

    if (!nameInput.value) {
        const lastName = localStorage.getItem('LAST_TOURNAMENT_NAME');
        if (lastName) {
            nameInput.value = lastName;
            updateTournamentTitle();
        }
    }

    const categoryName = document.getElementById('subTitleInput').value;
    const storageKey = getLocalStorageKey(categoryName);

    try {
        const storedData = localStorage.getItem(storageKey);
        if (storedData) {
            const loadedData = JSON.parse(storedData);

            if (loadedData.tournamentName) {
                document.getElementById('tournamentNameInput').value = loadedData.tournamentName;
                updateTournamentTitle();
            }

            autoSubTitle = loadedData.autoSubTitle || '';
            manualSubTitle = loadedData.manualSubTitle || '';
            document.getElementById('playersAuto').value = loadedData.playersAutoInput || '';
            document.getElementById('playersManual').value = loadedData.playersManualInput || '';
            document.getElementById('mode').value = loadedData.mode || 'auto';
            
            let consolationMode = loadedData.consolationMode || 'no';
            if (loadedData.enableConsolation !== undefined) {
                consolationMode = loadedData.enableConsolation ? 'yes' : 'no';
            }
            document.getElementById('consolationMode').value = consolationMode;
            setConsolationMode(consolationMode);
            
            document.getElementById('numGroupsAuto').value = loadedData.numGroupsAuto || 4;
            document.getElementById('numQualifiedPlayers').value = loadedData.numQualifiedPlayers || 2;
            document.getElementById('numGroupsManual').value = loadedData.numGroupsManual || 4;
            activeGroupView = loadedData.activeGroupView || 'table';
            
            if (loadedData.currentLanguage) {
                currentLanguage = loadedData.currentLanguage;
            }

            const modeSelect = document.getElementById('mode');
            document.getElementById('auto-panel').style.display = modeSelect.value === 'auto' ? 'block' : 'none';
            document.getElementById('manual-panel').style.display = modeSelect.value === 'auto' ? 'none' : 'block';
            document.getElementById('generateAutoGroupsBtn').style.display = modeSelect.value === 'auto' ? 'inline-block' : 'none';
            document.getElementById('generateManualGroupsBtn').style.display = modeSelect.value === 'auto' ? 'none' : 'inline-block';

            if (loadedData.manualGroupPlayersText) {
                const manualGroupCount = parseInt(document.getElementById('numGroupsManual').value);
                const container = document.getElementById('manual-groups');
                if (container) {
                     container.innerHTML = '';
                     for (let i = 0; i < manualGroupCount; i++) {
                        container.innerHTML += `
                            <div class="manual-group">
                                <label>${t('players')} ${t('group')} ${i+1}:</label>
                                <textarea id="manual-group-${i}" data-i18n-placeholder="enterPlayersManual" placeholder="${t('enterPlayersManual')}" oninput="saveManualGroupsInput()"></textarea>
                            </div>`;
                    }
                }

                for (let i = 0; i < manualGroupCount; i++) {
                    const elem = document.getElementById(`manual-group-${i}`);
                    if (elem && loadedData.manualGroupPlayersText[i] !== undefined) {
                        elem.value = loadedData.manualGroupPlayersText[i];
                    }
                }
            }

            groupPlayers = loadedData.groupPlayers || [];
            groupResults = loadedData.groupResults || [];
            groupStandings = loadedData.groupStandings || [];
            manualGroupPlayers = loadedData.manualGroupPlayers || [];
            manualGroupResults = loadedData.manualGroupResults || [];
            manualGroupStandings = loadedData.manualGroupStandings || [];
            autoKnockoutMatches = loadedData.autoKnockoutMatches || { quarterfinals: [], semifinals: [], final: null, thirdPlace: null };
            manualKnockoutMatches = loadedData.manualKnockoutMatches || { quarterfinals: [], semifinals: [], final: null, thirdPlace: null };
            autoConsolationMatches = loadedData.autoConsolationMatches || { semifinals: [], fifthPlace: null, seventhPlace: null };
            manualConsolationMatches = loadedData.manualConsolationMatches || { semifinals: [], fifthPlace: null, seventhPlace: null };
            autoPlayerColors = loadedData.autoPlayerColors || {};
            manualPlayerColors = loadedData.manualPlayerColors || {};

            autoKnockoutMatches.quarterfinals = autoKnockoutMatches.quarterfinals || [];
            autoKnockoutMatches.semifinals = autoKnockoutMatches.semifinals || [];
            manualKnockoutMatches.quarterfinals = manualKnockoutMatches.quarterfinals || [];
            manualKnockoutMatches.semifinals = manualKnockoutMatches.semifinals || [];
            autoConsolationMatches.semifinals = autoConsolationMatches.semifinals || [];
            manualConsolationMatches.semifinals = manualConsolationMatches.semifinals || [];

            updateSubTitleDisplay();
            renderGroups();
            displayBracket();
            toggleConsolationVisibility();
            displayConsolationBracket();
            handleByes();
            updateClassification();

            applyCollapseState('controlPanel', loadedData.controlPanelCollapsed);
            applyCollapseState('groupSection', loadedData.groupSectionCollapsed);
            applyCollapseState('knockoutSection', loadedData.knockoutSectionCollapsed);
            applyCollapseState('consolationSection', loadedData.consolationSectionCollapsed);

            document.querySelectorAll('.view-toggle-btn').forEach(btn => {
                if (btn.dataset.view === activeGroupView) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });

            applyTranslations();
            updateLanguageSwitch();

            const mode = document.getElementById('mode').value;
            const currentKnockoutMatches = mode === 'manual' ? manualKnockoutMatches : autoKnockoutMatches;
            const currentConsolationMatches = mode === 'manual' ? manualConsolationMatches : autoConsolationMatches;

            currentKnockoutMatches.quarterfinals.forEach(match => updateMatchUI(match, 'main'));
            currentKnockoutMatches.semifinals.forEach(match => updateMatchUI(match, 'main'));
            if (currentKnockoutMatches.final) updateMatchUI(currentKnockoutMatches.final, 'main');
            if (currentKnockoutMatches.thirdPlace) updateMatchUI(currentKnockoutMatches.thirdPlace, 'main');

            currentConsolationMatches.semifinals.forEach(match => updateMatchUI(match, 'consolation'));
            if (currentConsolationMatches.fifthPlace) updateMatchUI(currentConsolationMatches.fifthPlace, 'consolation');
            if (currentConsolationMatches.seventhPlace) updateMatchUI(currentConsolationMatches.seventhPlace, 'consolation');
            
            // Przywr贸 stany "Trwa" dla mecz贸w
            setTimeout(() => {
                document.querySelectorAll('.match-item').forEach(item => {
                    const id = item.id;
                    if (id && localStorage.getItem(`matchProgress_${id}`) === 'true') {
                        item.classList.add('match-in-progress');
                        const checkbox = item.querySelector('.match-inprogress-checkbox');
                        if (checkbox) checkbox.checked = true;
                    }
                });
            }, 200);
        }
    } catch (e) {
        alert(t('loadError'));
        clearTournamentData(false);
        resetTournamentUI();
    } finally {
        shouldSave = true;
    }
}

function applyCollapseState(containerId, isCollapsed) {
    const container = document.getElementById(containerId);
    if (container) {
        const button = container.querySelector('.collapse-button');
        const content = container.querySelector('.collapsible-content');
        if (isCollapsed) {
            container.classList.add('collapsed');
            if (button) button.textContent = t('expand');
            if (content) content.style.maxHeight = '0';
        } else {
            container.classList.remove('collapsed');
            if (button) button.textContent = t('collapse');
            if (content) {
                content.style.maxHeight = null;
            }
        }
    }
}

function updateMatchUI(match, type) {
    const matchDiv = document.querySelector(`.bracket-match[data-id="${match.id}"][data-type="${type}"]`);
    if (!matchDiv) return;

    const mode = document.getElementById('mode').value;
    const currentPlayerColors = mode === 'manual' ? manualPlayerColors : autoPlayerColors;

    const input1 = matchDiv.querySelector('.score-input[data-player="1"]');
    const input2 = matchDiv.querySelector('.score-input[data-player="2"]');
    const player1NameSpan = matchDiv.querySelector('.bracket-player:first-child .player-name');
    const player2NameSpan = matchDiv.querySelector('.bracket-player:last-child .player-name');
    const player1Row = matchDiv.querySelector('.bracket-player:first-child');
    const player2Row = matchDiv.querySelector('.bracket-player:last-child');

    if (player1NameSpan) player1NameSpan.textContent = match.player1 || '?';
    if (player2NameSpan) player2NameSpan.textContent = match.player2 || '?';

    if (player1Row) {
        player1Row.className = 'bracket-player';
        if (match.player1 && currentPlayerColors[match.player1]) {
            player1Row.classList.add(currentPlayerColors[match.player1]);
        }
    }
    if (player2Row) {
        player2Row.className = 'bracket-player';
        if (match.player2 && currentPlayerColors[match.player2]) {
            player2Row.classList.add(currentPlayerColors[match.player2]);
        }
    }

    if (input1) {
        input1.value = match.score1 || '';
        input1.disabled = (match.player1 === "WOLNY LOS" || match.player2 === "WOLNY LOS") || (match.score1 !== '' && match.score2 !== '');
    }
    if (input2) {
        input2.value = match.score2 || '';
        input2.disabled = (match.player1 === "WOLNY LOS" || match.player2 === "WOLNY LOS") || (match.score1 !== '' && match.score2 !== '');
    }
}

function clearTournamentData(confirmClear = true) {
    let shouldClear = true;
    if (confirmClear) {
        const dialogHtml = `
            <div id="clearDialog" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;">
                <div style="background:white;padding:20px;border-radius:10px;max-width:400px;width:90%;box-shadow:0 4px 12px rgba(0,0,0,0.3);">
                    <h3 style="margin-top:0;color:#2c3e50;">${t('selectDataToClear')}</h3>
                    <div style="margin:15px 0;">
                        <label style="display:block;margin:10px 0;cursor:pointer;">
                            <input type="checkbox" id="clearAuto" style="margin-right:8px;">
                            ${currentLanguage === 'pl' ? 'Tryb <strong>AUTOMATYCZNY</strong> (grupy, wyniki, drabinka)' : '<strong>AUTO</strong> mode (groups, results, bracket)'}
                        </label>
                        <label style="display:block;margin:10px 0;cursor:pointer;">
                            <input type="checkbox" id="clearManual" style="margin-right:8px;">
                            ${currentLanguage === 'pl' ? 'Tryb <strong>RCZNY</strong> (grupy, wyniki, drabinka)' : '<strong>MANUAL</strong> mode (groups, results, bracket)'}
                        </label>
                        <label style="display:block;margin:10px 0;cursor:pointer;">
                            <input type="checkbox" id="clearAll" style="margin-right:8px;">
                            ${currentLanguage === 'pl' ? '<strong>Wyczy WSZYSTKO</strong> (oba tryby)' : '<strong>Clear EVERYTHING</strong> (both modes)'}
                        </label>
                    </div>
                    <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:20px;">
                        <button onclick="document.getElementById('clearDialog').remove()" style="padding:8px 16px;background:#95a5a6;color:white;border:none;border-radius:5px;cursor:pointer;">${t('cancel')}</button>
                        <button onclick="processClearSelection()" style="padding:8px 16px;background:#e74c3c;color:white;border:none;border-radius:5px;cursor:pointer;">${t('clearSelected')}</button>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', dialogHtml);

        setTimeout(() => {
            const clearAllCheckbox = document.getElementById('clearAll');
            const clearAutoCheckbox = document.getElementById('clearAuto');
            const clearManualCheckbox = document.getElementById('clearManual');

            if (clearAllCheckbox) {
                clearAllCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        if (clearAutoCheckbox) clearAutoCheckbox.checked = false;
                        if (clearManualCheckbox) clearManualCheckbox.checked = false;
                    }
                });
            }

            if (clearAutoCheckbox) {
                clearAutoCheckbox.addEventListener('change', function() {
                    if (this.checked && clearAllCheckbox) {
                        clearAllCheckbox.checked = false;
                    }
                });
            }

            if (clearManualCheckbox) {
                clearManualCheckbox.addEventListener('change', function() {
                    if (this.checked && clearAllCheckbox) {
                        clearAllCheckbox.checked = false;
                    }
                });
            }
        }, 100);

        window.processClearSelection = function() {
            const clearAuto = document.getElementById('clearAuto')?.checked || false;
            const clearManual = document.getElementById('clearManual')?.checked || false;
            const clearAll = document.getElementById('clearAll')?.checked || false;

            document.getElementById('clearDialog')?.remove();

            if (!clearAuto && !clearManual && !clearAll) {
                alert(t('noOptionSelected'));
                return;
            }

            let confirmMessage = "";
            if (clearAll) {
                confirmMessage = t('confirmClearAll');
            } else {
                const selectedModes = [];
                if (clearAuto) selectedModes.push(currentLanguage === 'pl' ? "AUTOMATYCZNY" : "AUTO");
                if (clearManual) selectedModes.push(currentLanguage === 'pl' ? "RCZNY" : "MANUAL");
                confirmMessage = t('confirmClearSelected') + selectedModes.join(` ${t('and')} `) + "?";
            }

            if (!confirm(confirmMessage)) {
                console.log("Clearing cancelled by user in confirmation.");
                return;
            }

            const categoryName = document.getElementById('subTitleInput').value;
            const storageKey = getLocalStorageKey(categoryName);
            const tournamentName = document.getElementById('tournamentNameInput').value.trim() || 'Turniej';

            try {
                const storedData = localStorage.getItem(storageKey);
                let currentData = storedData ? JSON.parse(storedData) : {};

                if (clearAll) {
                    localStorage.removeItem(storageKey);
                    localStorage.removeItem(`manualGroupsInputData_${tournamentName.toUpperCase()}`);
                    console.log("Cleared ALL data (both modes).");
                    resetTournamentUI();
                    alert(t('allDataCleared'));
                    return;
                }

                if (clearAuto) {
                    currentData.groupPlayers = [];
                    currentData.groupResults = [];
                    currentData.groupStandings = [];
                    currentData.autoKnockoutMatches = { quarterfinals: [], semifinals: [], final: null, thirdPlace: null };
                    currentData.autoConsolationMatches = { semifinals: [], fifthPlace: null, seventhPlace: null };
                    currentData.autoPlayerColors = {};
                    currentData.autoSubTitle = '';
                    
                    localStorage.setItem(storageKey, JSON.stringify(currentData));
                    
                    document.getElementById('playersAuto').value = '';
                    console.log("Cleared AUTO mode data.");
                    
                    groupPlayers = [];
                    groupResults = [];
                    groupStandings = [];
                    autoKnockoutMatches = { quarterfinals: [], semifinals: [], final: null, thirdPlace: null };
                    autoConsolationMatches = { semifinals: [], fifthPlace: null, seventhPlace: null };
                    autoPlayerColors = {};
                    autoSubTitle = '';
                    
                    renderGroups();
                    displayBracket();
                    displayConsolationBracket();
                    updateClassification();
                    
                    if (document.getElementById('mode').value === 'auto') {
                        document.getElementById('subTitleInput').value = '';
                    }
                    
                    updateSubTitleDisplay();
                }

                if (clearManual) {
                    currentData.manualGroupPlayers = [];
                    currentData.manualGroupResults = [];
                    currentData.manualGroupStandings = [];
                    currentData.manualKnockoutMatches = { quarterfinals: [], semifinals: [], final: null, thirdPlace: null };
                    currentData.manualConsolationMatches = { semifinals: [], fifthPlace: null, seventhPlace: null };
                    currentData.manualPlayerColors = {};
                    currentData.manualSubTitle = '';
                    
                    localStorage.setItem(storageKey, JSON.stringify(currentData));
                    
                    document.getElementById('playersManual').value = '';
                    localStorage.removeItem(`manualGroupsInputData_${tournamentName.toUpperCase()}`);
                    console.log("Cleared MANUAL mode data.");
                    
                    manualGroupPlayers = [];
                    manualGroupResults = [];
                    manualGroupStandings = [];
                    manualKnockoutMatches = { quarterfinals: [], semifinals: [], final: null, thirdPlace: null };
                    manualConsolationMatches = { semifinals: [], fifthPlace: null, seventhPlace: null };
                    manualPlayerColors = {};
                    manualSubTitle = '';
                    
                    const manualGroupCount = parseInt(document.getElementById('numGroupsManual').value);
                    for (let i = 0; i < manualGroupCount; i++) {
                        const textarea = document.getElementById(`manual-group-${i}`);
                        if (textarea) {
                            textarea.value = '';
                        }
                    }
                    
                    if (document.getElementById('mode').value === 'manual') {
                        document.getElementById('subTitleInput').value = '';
                    }
                    
                    updateSubTitleDisplay();
                }
                
                localStorage.setItem(storageKey, JSON.stringify(currentData));

                renderGroups();
                displayBracket();
                displayConsolationBracket();
                updateClassification();

                const successMessages = [];
                if (clearAuto) successMessages.push(currentLanguage === 'pl' ? "trybu AUTOMATYCZNEGO" : "AUTO mode");
                if (clearManual) successMessages.push(currentLanguage === 'pl' ? "trybu RCZNEGO" : "MANUAL mode");

                alert(t('dataCleared') + successMessages.join(` ${t('and')} `));

            } catch (e) {
                console.error(`Error during selective clearing:`, e);
                alert(t('clearError'));
            }
        };

        return;
    }
}

function resetTournamentUI() {
    groupPlayers = [];
    groupResults = [];
    groupStandings = [];
    manualGroupPlayers = [];
    manualGroupResults = [];
    manualGroupStandings = [];
    autoKnockoutMatches = { quarterfinals: [], semifinals: [], final: null, thirdPlace: null };
    manualKnockoutMatches = { quarterfinals: [], semifinals: [], final: null, thirdPlace: null };
    autoConsolationMatches = { semifinals: [], fifthPlace: null, seventhPlace: null };
    manualConsolationMatches = { semifinals: [], fifthPlace: null, seventhPlace: null };
    autoPlayerColors = {};
    manualPlayerColors = {};
    autoSubTitle = '';
    manualSubTitle = '';
    activeGroupView = 'table';

    document.getElementById('playersAuto').value = '';
    document.getElementById('playersManual').value = '';
    document.getElementById('tournamentNameInput').value = '';
    document.getElementById('subTitleInput').value = '';
    document.getElementById('numGroupsAuto').value = 4;
    document.getElementById('numQualifiedPlayers').value = 2;
    document.getElementById('numGroupsManual').value = 4;
    document.getElementById('mode').value = 'auto';
    document.getElementById('consolationMode').value = 'no';
    setConsolationMode('no');

    renderManualGroups();
    document.getElementById('groups-container').innerHTML = '';
    document.getElementById('knockout-bracket').innerHTML = '';
    document.getElementById('consolation-bracket').innerHTML = '';

    for (let i = 1; i <= 8; i++) {
        const box = document.getElementById(`classification-place-${i}`);
        if (box) {
            const span = box.querySelector('.player-name');
            if (span) span.textContent = '?';
            box.className = 'classification-box';
            if (i >= 5 && i <= 8) {
                box.style.display = 'none';
            } else {
                box.style.display = '';
            }
        }
    }

    document.querySelectorAll('.score-input').forEach(input => input.disabled = false);
    toggleConsolationVisibility();
    switchMode();
    updateTournamentTitle();
    updateSubTitleDisplay();
}

function exportResultsToText() {
    console.log("Exporting results to text...");

    const currentLang = currentLanguage;
    const isAutoMode = document.getElementById('mode').value === 'auto';
    const autoText = currentLang === 'pl' ? 'Automatyczny' : 'Automatic';
    const manualText = currentLang === 'pl' ? 'Rczny' : 'Manual';
    const currentModeText = isAutoMode ? autoText : manualText;

    const selectExportModeText = currentLang === 'pl' ? translations.pl.selectExportMode : translations.en.selectExportMode;
    const currentModeLabel = currentLang === 'pl' ? translations.pl.currentMode : translations.en.currentMode;
    const bothModesText = currentLang === 'pl' ? translations.pl.bothModes : translations.en.bothModes;
    const exportText = currentLang === 'pl' ? translations.pl.export : translations.en.export;
    const cancelText = currentLang === 'pl' ? translations.pl.cancel : translations.en.cancel;
    const selectModeText = currentLang === 'pl' ? translations.pl.selectMode : translations.en.selectMode;

    const dialogHtml = `
        <div id="exportDialog" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;">
            <div style="background:white;padding:20px;border-radius:10px;max-width:400px;width:90%;box-shadow:0 4px 12px rgba(0,0,0,0.3);">
                <h3 style="margin-top:0;color:#2c3e50;">${selectExportModeText}</h3>
                <div style="margin:15px 0;">
                    <label style="display:block;margin:10px 0;cursor:pointer;">
                        <input type="radio" name="exportMode" value="current" checked style="margin-right:8px;">
                        <strong>${currentModeLabel}</strong> (${currentModeText})
                    </label>
                    <label style="display:block;margin:10px 0;cursor:pointer;">
                        <input type="radio" name="exportMode" value="auto" style="margin-right:8px;">
                        ${currentLang === 'pl' ? 'Tryb' : 'Mode'} <strong>${autoText}</strong>
                    </label>
                    <label style="display:block;margin:10px 0;cursor:pointer;">
                        <input type="radio" name="exportMode" value="manual" style="margin-right:8px;">
                        ${currentLang === 'pl' ? 'Tryb' : 'Mode'} <strong>${manualText}</strong>
                    </label>
                    <label style="display:block;margin:10px 0;cursor:pointer;">
                        <input type="radio" name="exportMode" value="both" style="margin-right:8px;">
                        <strong>${bothModesText}</strong> ${currentLang === 'pl' ? '(jeden plik)' : '(one file)'}
                    </label>
                </div>
                <div style="display:flex;justify-content:space-between;margin-top:20px;">
                    <button onclick="document.getElementById('exportDialog').remove()" style="padding:8px 16px;background:#95a5a6;color:white;border:none;border-radius:5px;cursor:pointer;">${cancelText}</button>
                    <button onclick="processExportSelection()" style="padding:8px 16px;background:#3498db;color:white;border:none;border-radius:5px;cursor:pointer;">${exportText}</button>
                </div>
            </div>
        </div>
    `;

    document.body.insertAdjacentHTML('beforeend', dialogHtml);

    window.processExportSelection = function() {
        const selectedMode = document.querySelector('input[name="exportMode"]:checked')?.value;

        document.getElementById('exportDialog')?.remove();

        if (!selectedMode) {
            alert(selectModeText);
            return;
        }

        performExport(selectedMode);
    };
}

function performExport(exportMode) {
    let textOutput = [];
    const tournamentName = document.getElementById('tournamentNameInput').value.trim() || t('tournamentName');
    const category = document.getElementById('subTitleInput').value.trim() || '';
    const consolationMode = document.getElementById('consolationMode').value;

    const getExportData = (mode) => {
        const currentSubTitle = mode === 'manual' ? manualSubTitle : autoSubTitle;
        const currentGroupPlayers = mode === 'manual' ? manualGroupPlayers : groupPlayers;
        const currentGroupStandings = mode === 'manual' ? manualGroupStandings : groupStandings;
        const currentKnockoutMatches = mode === 'manual' ? manualKnockoutMatches : autoKnockoutMatches;
        const currentConsolationMatches = mode === 'manual' ? manualConsolationMatches : autoConsolationMatches;

        return {
            currentSubTitle,
            currentGroupPlayers,
            currentGroupStandings,
            currentKnockoutMatches,
            currentConsolationMatches,
            modeName: mode === 'auto' ? t('autoMode') : t('manualMode')
        };
    };

    const formatMatch = (match, prefix = "") => {
        if (match && match.player1 && match.player2 && match.player1 !== "WOLNY LOS" && match.player2 !== "WOLNY LOS") {
            const score1 = match.score1 || '?';
            const score2 = match.score2 || '?';
            const winner = match.winner ? ` [${t('winner')}: ${match.winner}]` : '';
            return `${prefix}${match.player1} ${score1}:${score2} ${match.player2}${winner}`;
        }
        return null;
    };

    // NAGWEK Z NAZW TURNIEJU I KATEGORI
    textOutput.push(`--- ${t('tournamentResults')}: ${tournamentName} ---`);
    if (category) {
        textOutput.push(`${t('category')}: ${category}`);
    }
    textOutput.push(`${t('exportDate')}: ${new Date().toLocaleString()}`);
    textOutput.push('');
    
    // ========== POPRAWIONA LOGIKA DLA TRYBU "BOTH" ==========
    if (exportMode === 'both') {
        // Eksportuj oba tryby w jednym pliku
        textOutput.push(`=== ${t('bothModes')} ===`);
        textOutput.push('');
        
        // EKSPORT TRYBU AUTOMATYCZNEGO
        const autoData = getExportData('auto');
        const hasAutoData = autoData.currentGroupPlayers && 
                           autoData.currentGroupPlayers.length > 0 && 
                           autoData.currentGroupPlayers.some(g => g && g.length > 0);
        
        if (hasAutoData) {
            textOutput.push(`==== ${t('autoMode')} ====`);
            
            // DODAJ KATEGORI WEWNTRZ EKSPORTU
            if (autoData.currentSubTitle) {
                textOutput.push(`${t('category')}: ${autoData.currentSubTitle}`);
                textOutput.push('');
            }
            
            // Faza grupowa - tryb automatyczny
            textOutput.push(`=== ${t('groupStage')} ===`);
            autoData.currentGroupStandings.forEach((standings, groupIndex) => {
                if (standings && standings.length > 0) {
                    textOutput.push(`\n${t('group')} ${groupIndex + 1}:`);
                    standings.forEach((stat, placeIndex) => {
                        if (stat && autoData.currentGroupPlayers[groupIndex]) {
                            const player = autoData.currentGroupPlayers[groupIndex][stat.playerIndex];
                            const setsInfo = `${stat.setsWon}:${stat.setsLost}`;
                            const qualified = placeIndex < parseInt(document.getElementById('numQualifiedPlayers').value) ? ` (${t('qualified')})` : "";
                            textOutput.push(`${placeIndex + 1}. ${player} - ${t('points')}: ${stat.points}, ${t('sets')}: ${setsInfo}${qualified}`);
                        }
                    });
                }
            });
            textOutput.push('');
            
            // Faza pucharowa - tryb automatyczny
            if (autoData.currentKnockoutMatches && autoData.currentKnockoutMatches.quarterfinals.some(m => m.player1)) {
                textOutput.push(`=== ${t('knockoutStage')} ===`);
                
                textOutput.push(`\n${t('quarterfinals')}:`);
                autoData.currentKnockoutMatches.quarterfinals.forEach(m => {
                    const formatted = formatMatch(m, "  ");
                    if (formatted) textOutput.push(formatted);
                });
                
                if (autoData.currentKnockoutMatches.semifinals.some(m => m.player1)) {
                    textOutput.push(`\n${t('semifinals')}:`);
                    autoData.currentKnockoutMatches.semifinals.forEach(m => {
                        const formatted = formatMatch(m, "  ");
                        if (formatted) textOutput.push(formatted);
                    });
                }
                
                const thirdPlaceMatch = formatMatch(autoData.currentKnockoutMatches.thirdPlace, `${t('thirdPlace')}: `);
                if (thirdPlaceMatch) textOutput.push("\n" + thirdPlaceMatch);
                
                const finalMatch = formatMatch(autoData.currentKnockoutMatches.final, `${t('final')}: `);
                if (finalMatch) textOutput.push("\n" + finalMatch);
                
                textOutput.push('');
            }
            
            // Turniej pocieszenia - tryb automatyczny
            if (consolationMode === 'yes' && autoData.currentConsolationMatches && 
                autoData.currentConsolationMatches.semifinals.some(m => m.player1)) {
                textOutput.push(`=== ${t('consolationTournament')} (${t('places')} 5-8) ===`);
                
                textOutput.push(`\n${t('consolationSemifinals')}:`);
                autoData.currentConsolationMatches.semifinals.forEach(m => {
                    const formatted = formatMatch(m, "  ");
                    if (formatted) textOutput.push(formatted);
                });
                
                const seventhPlaceMatch = formatMatch(autoData.currentConsolationMatches.seventhPlace, `${t('seventhPlace')}: `);
                if (seventhPlaceMatch) textOutput.push("\n" + seventhPlaceMatch);
                
                const fifthPlaceMatch = formatMatch(autoData.currentConsolationMatches.fifthPlace, `${t('fifthPlace')}: `);
                if (fifthPlaceMatch) textOutput.push("\n" + fifthPlaceMatch);
                
                textOutput.push('');
            }
            
            // Klasyfikacja kocowa - tryb automatyczny
            textOutput.push(`=== ${t('finalClassification')} (${t('autoMode')}) ===`);
            const autoClassification = getFinalClassification(autoData.currentKnockoutMatches, 
                                                             autoData.currentConsolationMatches, 
                                                             consolationMode === 'yes');
            const autoClassifiedPlaces = Object.keys(autoClassification).map(Number).sort((a,b) => a-b);
            if (autoClassifiedPlaces.length > 0) {
                for (const place of autoClassifiedPlaces) {
                    const player = autoClassification[place];
                    if (player && player !== "WOLNY LOS") {
                        textOutput.push(`${place}. ${player}`);
                    }
                }
            } else {
                textOutput.push(t('noClassificationData'));
            }
            
            textOutput.push('\n' + '='.repeat(40) + '\n');
        }
        
        // EKSPORT TRYBU RCZNEGO
        const manualData = getExportData('manual');
        const hasManualData = manualData.currentGroupPlayers && 
                             manualData.currentGroupPlayers.length > 0 && 
                             manualData.currentGroupPlayers.some(g => g && g.length > 0);
        
        if (hasManualData) {
            textOutput.push(`==== ${t('manualMode')} ====`);
            
            // DODAJ KATEGORI WEWNTRZ EKSPORTU
            if (manualData.currentSubTitle) {
                textOutput.push(`${t('category')}: ${manualData.currentSubTitle}`);
                textOutput.push('');
            }
            
            // Faza grupowa - tryb rczny
            textOutput.push(`=== ${t('groupStage')} ===`);
            manualData.currentGroupStandings.forEach((standings, groupIndex) => {
                if (standings && standings.length > 0) {
                    textOutput.push(`\n${t('group')} ${groupIndex + 1}:`);
                    standings.forEach((stat, placeIndex) => {
                        if (stat && manualData.currentGroupPlayers[groupIndex]) {
                            const player = manualData.currentGroupPlayers[groupIndex][stat.playerIndex];
                            const setsInfo = `${stat.setsWon}:${stat.setsLost}`;
                            const qualified = placeIndex < parseInt(document.getElementById('numQualifiedPlayersManual').value) ? ` (${t('qualified')})` : "";
                            textOutput.push(`${placeIndex + 1}. ${player} - ${t('points')}: ${stat.points}, ${t('sets')}: ${setsInfo}${qualified}`);
                        }
                    });
                }
            });
            textOutput.push('');
            
            // Faza pucharowa - tryb rczny
            if (manualData.currentKnockoutMatches && manualData.currentKnockoutMatches.quarterfinals.some(m => m.player1)) {
                textOutput.push(`=== ${t('knockoutStage')} ===`);
                
                textOutput.push(`\n${t('quarterfinals')}:`);
                manualData.currentKnockoutMatches.quarterfinals.forEach(m => {
                    const formatted = formatMatch(m, "  ");
                    if (formatted) textOutput.push(formatted);
                });
                
                if (manualData.currentKnockoutMatches.semifinals.some(m => m.player1)) {
                    textOutput.push(`\n${t('semifinals')}:`);
                    manualData.currentKnockoutMatches.semifinals.forEach(m => {
                        const formatted = formatMatch(m, "  ");
                        if (formatted) textOutput.push(formatted);
                    });
                }
                
                const thirdPlaceMatch = formatMatch(manualData.currentKnockoutMatches.thirdPlace, `${t('thirdPlace')}: `);
                if (thirdPlaceMatch) textOutput.push("\n" + thirdPlaceMatch);
                
                const finalMatch = formatMatch(manualData.currentKnockoutMatches.final, `${t('final')}: `);
                if (finalMatch) textOutput.push("\n" + finalMatch);
                
                textOutput.push('');
            }
            
            // Turniej pocieszenia - tryb rczny
            if (consolationMode === 'yes' && manualData.currentConsolationMatches && 
                manualData.currentConsolationMatches.semifinals.some(m => m.player1)) {
                textOutput.push(`=== ${t('consolationTournament')} (${t('places')} 5-8) ===`);
                
                textOutput.push(`\n${t('consolationSemifinals')}:`);
                manualData.currentConsolationMatches.semifinals.forEach(m => {
                    const formatted = formatMatch(m, "  ");
                    if (formatted) textOutput.push(formatted);
                });
                
                const seventhPlaceMatch = formatMatch(manualData.currentConsolationMatches.seventhPlace, `${t('seventhPlace')}: `);
                if (seventhPlaceMatch) textOutput.push("\n" + seventhPlaceMatch);
                
                const fifthPlaceMatch = formatMatch(manualData.currentConsolationMatches.fifthPlace, `${t('fifthPlace')}: `);
                if (fifthPlaceMatch) textOutput.push("\n" + fifthPlaceMatch);
                
                textOutput.push('');
            }
            
            // Klasyfikacja kocowa - tryb rczny
            textOutput.push(`=== ${t('finalClassification')} (${t('manualMode')}) ===`);
            const manualClassification = getFinalClassification(manualData.currentKnockoutMatches, 
                                                               manualData.currentConsolationMatches, 
                                                               consolationMode === 'yes');
            const manualClassifiedPlaces = Object.keys(manualClassification).map(Number).sort((a,b) => a-b);
            if (manualClassifiedPlaces.length > 0) {
                for (const place of manualClassifiedPlaces) {
                    const player = manualClassification[place];
                    if (player && player !== "WOLNY LOS") {
                        textOutput.push(`${place}. ${player}`);
                    }
                }
            } else {
                textOutput.push(t('noClassificationData'));
            }
        }
        
    } else {
        // ========== ORYGINALNA LOGIKA DLA POJEDYNCZYCH TRYBW ==========
        const targetMode = exportMode === 'current' ? document.getElementById('mode').value : exportMode;
        const data = getExportData(targetMode);

        // DODAJ KATEGORI DLA POJEDYNCZYCH TRYBW
        if (data.currentSubTitle) {
            textOutput.push(`${t('category')}: ${data.currentSubTitle}`);
        }
        textOutput.push(`${t('mode')}: ${data.modeName}`);
        textOutput.push('');

        if (data.currentGroupPlayers && data.currentGroupPlayers.length > 0 && data.currentGroupPlayers.some(g => g && g.length > 0)) {
            textOutput.push(`=== ${t('groupStage')} ===`);
            data.currentGroupStandings.forEach((standings, groupIndex) => {
                if (standings && standings.length > 0) {
                    textOutput.push(`\n${t('group')} ${groupIndex + 1}:`);
                    standings.forEach((stat, placeIndex) => {
                        if (stat && data.currentGroupPlayers[groupIndex]) {
                            const player = data.currentGroupPlayers[groupIndex][stat.playerIndex];
                            const setsInfo = `${stat.setsWon}:${stat.setsLost}`;
                            const qualified = placeIndex < parseInt(document.getElementById(targetMode === 'manual' ? 'numQualifiedPlayersManual' : 'numQualifiedPlayers').value) ? ` (${t('qualified')})` : "";
                            textOutput.push(`${placeIndex + 1}. ${player} - ${t('points')}: ${stat.points}, ${t('sets')}: ${setsInfo}${qualified}`);
                        }
                    });
                }
            });
            textOutput.push('');
        }

        if (data.currentKnockoutMatches && data.currentKnockoutMatches.quarterfinals.some(m => m.player1)) {
            textOutput.push(`=== ${t('knockoutStage')} ===`);

            textOutput.push(`\n${t('quarterfinals')}:`);
            data.currentKnockoutMatches.quarterfinals.forEach(m => {
                const formatted = formatMatch(m, "  ");
                if (formatted) textOutput.push(formatted);
            });

            if (data.currentKnockoutMatches.semifinals.some(m => m.player1)) {
                textOutput.push(`\n${t('semifinals')}:`);
                data.currentKnockoutMatches.semifinals.forEach(m => {
                    const formatted = formatMatch(m, "  ");
                    if (formatted) textOutput.push(formatted);
                });
            }

            const thirdPlaceMatch = formatMatch(data.currentKnockoutMatches.thirdPlace, `${t('thirdPlace')}: `);
            if (thirdPlaceMatch) textOutput.push("\n" + thirdPlaceMatch);

            const finalMatch = formatMatch(data.currentKnockoutMatches.final, `${t('final')}: `);
            if (finalMatch) textOutput.push("\n" + finalMatch);
            textOutput.push('');
        }

        if (consolationMode === 'yes' && data.currentConsolationMatches && data.currentConsolationMatches.semifinals.some(m => m.player1)) {
            textOutput.push(`=== ${t('consolationTournament')} (${t('places')} 5-8) ===`);

            textOutput.push(`\n${t('consolationSemifinals')}:`);
            data.currentConsolationMatches.semifinals.forEach(m => {
                const formatted = formatMatch(m, "  ");
                if (formatted) textOutput.push(formatted);
            });

            const seventhPlaceMatch = formatMatch(data.currentConsolationMatches.seventhPlace, `${t('seventhPlace')}: `);
            if (seventhPlaceMatch) textOutput.push("\n" + seventhPlaceMatch);

            const fifthPlaceMatch = formatMatch(data.currentConsolationMatches.fifthPlace, `${t('fifthPlace')}: `);
            if (fifthPlaceMatch) textOutput.push("\n" + fifthPlaceMatch);
            textOutput.push('');
        }

        textOutput.push(`=== ${t('finalClassification')} ===`);
        const classification = getFinalClassification(data.currentKnockoutMatches, data.currentConsolationMatches, consolationMode === 'yes');
        const classifiedPlaces = Object.keys(classification).map(Number).sort((a,b) => a-b);
        if (classifiedPlaces.length > 0) {
            for (const place of classifiedPlaces) {
                const player = classification[place];
                if (player && player !== "WOLNY LOS") {
                    textOutput.push(`${place}. ${player}`);
                }
            }
        } else {
            textOutput.push(t('noClassificationData'));
        }
    }

    const finalString = textOutput.join('\n');
    const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    
    // DODAJ KATEGORI DO NAZWY PLIKU
    let baseName = tournamentName.replace(/[^a-zA-Z0-9]/g, '_');
    if (category) {
        baseName += '_' + category.replace(/[^a-zA-Z0-9]/g, '_');
    }
    
    const modeSuffix = exportMode === 'both' ? 'BOTH' : 
                      (exportMode === 'current' ? document.getElementById('mode').value.toUpperCase() : exportMode.toUpperCase());
    
    const filename = `${baseName}_${modeSuffix}_${date}.txt`;

    saveToAndroidFile(finalString, filename, 'text/plain');

    if (!androidInterface) {
        alert(`${t('exportSuccess')}:\n${filename}`);
    }
}

function getFinalClassification(knockoutMatches, consolationMatches, isConsolationActive) {
    const classification = {};

    if (knockoutMatches.final && knockoutMatches.final.winner) {
        classification[1] = knockoutMatches.final.winner;
        classification[2] = knockoutMatches.final.loser;
    }
    if (knockoutMatches.thirdPlace && knockoutMatches.thirdPlace.winner) {
        classification[3] = knockoutMatches.thirdPlace.winner;
        classification[4] = knockoutMatches.thirdPlace.loser;
    }
    if (isConsolationActive) {
        if (consolationMatches.fifthPlace && consolationMatches.fifthPlace.winner) {
            classification[5] = consolationMatches.fifthPlace.winner;
            classification[6] = consolationMatches.fifthPlace.loser;
        }
        if (consolationMatches.seventhPlace && consolationMatches.seventhPlace.winner) {
            classification[7] = consolationMatches.seventhPlace.winner;
            classification[8] = consolationMatches.seventhPlace.loser;
        }
    }

    return classification;
}

function saveTournamentToFile() {
    const tournamentName = document.getElementById('tournamentNameInput').value.trim() || t('tournamentName');
    const category = document.getElementById('subTitleInput').value.trim() || '';

    const tournamentData = {
        tournamentName: tournamentName,
        category: category, // DODANE
        autoSubTitle: autoSubTitle,
        manualSubTitle: manualSubTitle,
        playersAuto: document.getElementById('playersAuto').value,
        playersManual: document.getElementById('playersManual').value,
        mode: document.getElementById('mode').value,
        consolationMode: document.getElementById('consolationMode').value,
        numGroupsAuto: document.getElementById('numGroupsAuto').value,
        numQualifiedPlayers: document.getElementById('numQualifiedPlayers').value,
        numGroupsManual: document.getElementById('numGroupsManual').value,
        numQualifiedPlayersManual: document.getElementById('numQualifiedPlayersManual').value,
        currentLanguage: currentLanguage,

        autoData: {
            groupPlayers: groupPlayers,
            groupResults: groupResults,
            groupStandings: groupStandings,
            autoKnockoutMatches: autoKnockoutMatches,
            autoConsolationMatches: autoConsolationMatches,
            autoPlayerColors: autoPlayerColors
        },

        manualData: {
            manualGroupPlayers: manualGroupPlayers,
            manualGroupResults: manualGroupResults,
            manualGroupStandings: manualGroupStandings,
            manualKnockoutMatches: manualKnockoutMatches,
            manualConsolationMatches: manualConsolationMatches,
            manualPlayerColors: manualPlayerColors,
            manualGroupsInput: getManualGroupsInput()
        }
    };

    const dataStr = JSON.stringify(tournamentData, null, 2);
    
    // DODAJ KATEGORI DO NAZWY PLIKU
    let baseName = tournamentName.replace(/[^a-zA-Z0-9]/g, '_');
    if (category) {
        baseName += '_' + category.replace(/[^a-zA-Z0-9]/g, '_');
    }
    
    const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
    const filename = `${baseName}_${date}.json`;

    saveToAndroidFile(dataStr, filename, 'application/json');

    if (!androidInterface) {
        alert(`${t('saveSuccess')}:\n${filename}`);
    }
}

function getManualGroupsInput() {
    const numGroups = parseInt(document.getElementById('numGroupsManual').value);
    const manualGroups = {};

    for (let i = 0; i < numGroups; i++) {
        const textarea = document.getElementById(`manual-group-${i}`);
        if (textarea) {
            manualGroups[i] = textarea.value;
        }
    }

    return manualGroups;
}

function loadTournamentFromFile() {
    loadFromAndroidFile();
}

function showLoadDialog(tournamentData) {
    if (!tournamentData) {
        alert(t('loadError'));
        return;
    }

    const hasBasicData = (tournamentData.tournamentName && tournamentData.tournamentName.trim() !== '') || 
                         (tournamentData.playersAuto && tournamentData.playersAuto.trim() !== '') ||
                         (tournamentData.playersManual && tournamentData.playersManual.trim() !== '');

    const hasAutoData = tournamentData.autoData && 
                        (tournamentData.autoData.groupPlayers?.length > 0 || tournamentData.autoData.autoKnockoutMatches);

    const hasManualData = tournamentData.manualData && 
                          (tournamentData.manualData.manualGroupPlayers?.length > 0 || tournamentData.manualData.manualKnockoutMatches);

    if (!hasBasicData && !hasAutoData && !hasManualData) {
        alert(t('noTournamentData'));
        return;
    }

    const dialog = document.createElement('div');
    dialog.id = 'loadDialog';
    dialog.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        z-index: 1000;
        min-width: 300px;
    `;

    let optionsHtml = '';
    
    if (hasAutoData && hasManualData) {
        optionsHtml = `
            <p><strong>${t('fileContainsBoth')}</strong></p>
            <label><input type="radio" name="loadMode" value="both" checked> ${t('bothModes')}</label><br>
            <label><input type="radio" name="loadMode" value="auto"> ${t('autoModeOnly')}</label><br>
            <label><input type="radio" name="loadMode" value="manual"> ${t('manualModeOnly')}</label>
        `;
    } else if (hasAutoData) {
        optionsHtml = `
            <p><strong>${t('fileContainsAuto')}</strong></p>
            <label><input type="radio" name="loadMode" value="auto" checked> ${t('loadAuto')}</label>
        `;
    } else if (hasManualData) {
        optionsHtml = `
            <p><strong>${t('fileContainsManual')}</strong></p>
            <label><input type="radio" name="loadMode" value="manual" checked> ${t('loadManual')}</label>
        `;
    } else {
        optionsHtml = `
            <p><strong>${t('fileContainsBasic')}</strong></p>
            <label><input type="radio" name="loadMode" value="${tournamentData.mode || 'auto'}" checked> ${t('loadFormData')}</label>
        `;
    }

    dialog.innerHTML = `
        <h3>${t('loadingTournament')}: ${tournamentData.tournamentName || t('noName')}</h3>
        ${optionsHtml}
        <div style="margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px;">
            <button onclick="document.getElementById('loadDialog').remove()" style="padding: 8px 16px; background: #95a5a6; color: white; border: none; border-radius: 5px; cursor: pointer;">${t('cancel')}</button>
            <button onclick="window.processLoadSelection(${JSON.stringify(tournamentData).replace(/"/g, '&quot;')})" style="padding: 8px 16px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">${t('load')}</button>
        </div>
    `;

    document.body.appendChild(dialog);
}

function loadBothModes(tournamentData) {
    autoSubTitle = tournamentData.autoSubTitle || '';
    manualSubTitle = tournamentData.manualSubTitle || '';

    if (tournamentData.autoData) {
        groupPlayers = tournamentData.autoData.groupPlayers || [];
        groupResults = tournamentData.autoData.groupResults || [];
        groupStandings = tournamentData.autoData.groupStandings || [];
        autoKnockoutMatches = tournamentData.autoData.autoKnockoutMatches || { quarterfinals: [], semifinals: [], final: null, thirdPlace: null };
        autoConsolationMatches = tournamentData.autoData.autoConsolationMatches || { semifinals: [], fifthPlace: null, seventhPlace: null };
        autoPlayerColors = tournamentData.autoData.autoPlayerColors || {};
    }

    if (tournamentData.manualData) {
        manualGroupPlayers = tournamentData.manualData.manualGroupPlayers || [];
        manualGroupResults = tournamentData.manualData.manualGroupResults || [];
        manualGroupStandings = tournamentData.manualData.manualGroupStandings || [];
        manualKnockoutMatches = tournamentData.manualData.manualKnockoutMatches || { quarterfinals: [], semifinals: [], final: null, thirdPlace: null };
        manualConsolationMatches = tournamentData.manualData.manualConsolationMatches || { semifinals: [], fifthPlace: null, seventhPlace: null };
        manualPlayerColors = tournamentData.manualData.manualPlayerColors || {};
    }
}

window.processLoadSelection = function(tournamentData) {
    const selectedMode = document.querySelector('input[name="loadMode"]:checked')?.value;
    document.getElementById('loadDialog')?.remove();

    if (!selectedMode) {
        alert(t('selectMode'));
        return;
    }

    restoreUIFromLoadedData(tournamentData);

    if (selectedMode === 'auto') {
        document.getElementById('playersManual').value = '';
        const manualGroupCount = parseInt(document.getElementById('numGroupsManual').value);
        for (let i = 0; i < manualGroupCount; i++) {
            const textarea = document.getElementById(`manual-group-${i}`);
            if (textarea) {
                textarea.value = '';
            }
        }
        manualSubTitle = '';
    } else if (selectedMode === 'manual') {
        document.getElementById('playersAuto').value = '';
        autoSubTitle = '';
    }

    if (selectedMode === 'both') {
        loadBothModes(tournamentData);
    } else {
        if (selectedMode === 'auto') {
            autoSubTitle = tournamentData.autoData?.autoSubTitle || tournamentData.autoSubTitle || '';
            groupPlayers = tournamentData.autoData?.groupPlayers || [];
            groupResults = tournamentData.autoData?.groupResults || [];
            groupStandings = tournamentData.autoData?.groupStandings || [];
            autoKnockoutMatches = tournamentData.autoData?.autoKnockoutMatches || { quarterfinals: [], semifinals: [], final: null, thirdPlace: null };
            autoConsolationMatches = tournamentData.autoData?.autoConsolationMatches || { semifinals: [], fifthPlace: null, seventhPlace: null };
            autoPlayerColors = tournamentData.autoData?.autoPlayerColors || {};
        } else {
            manualSubTitle = tournamentData.manualData?.manualSubTitle || tournamentData.manualSubTitle || '';
            manualGroupPlayers = tournamentData.manualData?.manualGroupPlayers || [];
            manualGroupResults = tournamentData.manualData?.manualGroupResults || [];
            manualGroupStandings = tournamentData.manualData?.manualGroupStandings || [];
            manualKnockoutMatches = tournamentData.manualData?.manualKnockoutMatches || { quarterfinals: [], semifinals: [], final: null, thirdPlace: null };
            manualConsolationMatches = tournamentData.manualData?.manualConsolationMatches || { semifinals: [], fifthPlace: null, seventhPlace: null };
            manualPlayerColors = tournamentData.manualData?.manualPlayerColors || {};
        }
    }

    renderGroups();
    displayBracket();
    toggleConsolationVisibility();
    displayConsolationBracket();
    handleByes();
    updateClassification();
    
    switchMode();
    updateSubTitleDisplay();

    applyCollapseState('controlPanel', tournamentData.controlPanelCollapsed);
    applyCollapseState('groupSection', tournamentData.groupSectionCollapsed);
    applyCollapseState('knockoutSection', tournamentData.knockoutSectionCollapsed);
    applyCollapseState('consolationSection', tournamentData.consolationSectionCollapsed);

    alert(t('loadSuccess'));
};

function restoreUIFromLoadedData(tournamentData) {
    document.getElementById('tournamentNameInput').value = tournamentData.tournamentName || '';
    document.getElementById('playersAuto').value = tournamentData.playersAuto || '';
    document.getElementById('playersManual').value = tournamentData.playersManual || '';
    document.getElementById('mode').value = tournamentData.mode || 'auto';
    
    let consolationMode = tournamentData.consolationMode || 'no';
    if (tournamentData.enableConsolation !== undefined) {
        consolationMode = tournamentData.enableConsolation ? 'yes' : 'no';
    }
    document.getElementById('consolationMode').value = consolationMode;
    setConsolationMode(consolationMode);
    
    document.getElementById('numGroupsAuto').value = tournamentData.numGroupsAuto || 4;
    document.getElementById('numQualifiedPlayers').value = tournamentData.numQualifiedPlayers || 2;
    document.getElementById('numGroupsManual').value = tournamentData.numGroupsManual || 4;
    document.getElementById('numQualifiedPlayersManual').value = tournamentData.numQualifiedPlayersManual || 2;

    autoSubTitle = tournamentData.autoSubTitle || '';
    manualSubTitle = tournamentData.manualSubTitle || '';

    const subTitleInput = document.getElementById('subTitleInput');
    if (tournamentData.mode === 'manual') {
        subTitleInput.value = manualSubTitle;
    } else {
        subTitleInput.value = autoSubTitle;
    }

    updateTournamentTitle();

    let manualGroupsData = null;
    
    if (tournamentData.manualData && tournamentData.manualData.manualGroupsInput) {
        manualGroupsData = tournamentData.manualData.manualGroupsInput;
    } else if (tournamentData.manualGroupsInput) {
        manualGroupsData = tournamentData.manualGroupsInput;
    } else if (tournamentData.manualData && tournamentData.manualData.manualGroupPlayers) {
        manualGroupsData = {};
        tournamentData.manualData.manualGroupPlayers.forEach((players, index) => {
            manualGroupsData[index] = players.join('\n');
        });
    }
    
    if (manualGroupsData) {
        const numGroups = parseInt(document.getElementById('numGroupsManual').value);
        renderManualGroups(); 
        
        for (let i = 0; i < numGroups; i++) {
            const textarea = document.getElementById(`manual-group-${i}`);
            if (textarea && manualGroupsData[i] !== undefined && manualGroupsData[i] !== null) {
                textarea.value = manualGroupsData[i];
            }
        }
    }
}

window.onload = function() {
    currentLanguage = localStorage.getItem('appLanguage') || detectLanguage();
    applyTranslations();
    updateLanguageSwitch();
    
    const numGroupsAuto = document.getElementById('numGroupsAuto');
    const numGroupsManual = document.getElementById('numGroupsManual');
    if (numGroupsAuto && numGroupsManual) {
        numGroupsManual.value = numGroupsAuto.value;
    }

    updateTournamentTitle();
    renderManualGroups();
    switchMode();
    updateSubTitleDisplay();
    loadState();

    const fileInput = document.createElement('input');
    fileInput.type = 'file';
    fileInput.id = 'fileInput';
    fileInput.accept = '.json';
    fileInput.style.display = 'none';
    fileInput.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const tournamentData = JSON.parse(e.target.result);
                showLoadDialog(tournamentData);
            } catch (error) {
                alert(t('loadError'));
            }
        };
        reader.readAsText(file);
    };
    document.body.appendChild(fileInput);

    document.querySelectorAll('.view-toggle-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            switchGroupView(this.dataset.view);
        });
    });
};

function initMobileFeatures() {
    const tables = document.querySelectorAll('.table-container');
    tables.forEach(table => {
        table.addEventListener('touchstart', function(e) {
            this.style.cursor = 'grabbing';
        });

        table.addEventListener('touchend', function(e) {
            this.style.cursor = 'grab';
        });
    });
}

window.addEventListener('load', function() {
    initMobileFeatures();
});

// DODATKOWE TUMACZENIA
translations.pl.enterPlayersFirst = "Wpisz zawodnik贸w przed generowaniem grup!";
translations.pl.invalidScore = "Wynik musi by liczb!";
translations.pl.invalidScoreFormat = "Nieprawidowy format wyniku! U偶yj formatu '3:2'";
translations.pl.noQualifiedPlayers = "Brak zakwalifikowanych zawodnik贸w do fazy pucharowej.";
translations.pl.tooManyPlayers = "Wykryto wicej ni偶 8 zakwalifikowanych zawodnik贸w. Do drabinki pucharowej zostanie wybranych pierwszych 8 zawodnik贸w z najwy偶szym rankingiem og贸lnym.";
translations.pl.enableConsolationFirst = "Aby wygenerowa drabink pocieszenia, zaznacz opcj 'Rozgrywaj Turniej Pocieszenia' w ustawieniach.";
translations.pl.notEnoughLosers = "Brak wystarczajcej liczby przegranych z wierfina贸w (potrzeba 4) do wygenerowania Turnieju Pocieszenia.";
translations.pl.saveError = "Bd podczas zapisu danych.";
translations.pl.loadError = "Bd podczas wczytywania pliku.";
translations.pl.saveSuccess = "Plik zosta zapisany: ";
translations.pl.confirmClear = "Czy na pewno chcesz wyczyci wszystkie dane turniejowe?";
translations.pl.clearSuccess = "Wszystkie dane turniejowe zostay wyczyszczone.";
translations.pl.noTournamentData = "Wczytany plik nie zawiera 偶adnych danych turniejowych.";
translations.pl.loadSuccess = "Turniej zosta pomylnie wczytany!";
translations.pl.winner = "ZWYCIZCA";
translations.pl.qualified = "Q";
translations.pl.points = "Punkty";
translations.pl.sets = "Sety";
translations.pl.setBalance = "Bilans set贸w (W:P)";
translations.pl.place = "Miejsce";
translations.pl.places = "miejsca";
translations.pl.tournamentResults = "WYNIKI TURNIEJU";
translations.pl.exportDate = "Data eksportu";
translations.pl.finalClassification = "Klasyfikacja Kocowa";
translations.pl.noClassificationData = "Brak danych do wywietlenia klasyfikacji kocowej.";
translations.pl.selectExportMode = "Wybierz tryb do eksportu";
translations.pl.currentMode = "AKTUALNY TRYB";
translations.pl.export = "Eksportuj";
translations.pl.cancel = "Anuluj";
translations.pl.exportSuccess = "Wyniki zostay wyeksportowane do pliku";
translations.pl.selectMode = "Nie wybrano tryb do eksportu.";
translations.pl.fileContainsBoth = "Plik zawiera dane obu tryb贸w. Wybierz tryb do wczytywania:";
translations.pl.bothModes = "Oba tryby";
translations.pl.autoModeOnly = "Tylko tryb automatyczny";
translations.pl.manualModeOnly = "Tylko tryb rczny";
translations.pl.fileContainsAuto = "Plik zawiera dane trybu automatycznego oraz formularza.";
translations.pl.loadAuto = "Wczytaj tryb automatyczny";
translations.pl.fileContainsManual = "Plik zawiera dane trybu rcznego oraz formularza.";
translations.pl.loadManual = "Wczytaj tryb rczny";
translations.pl.fileContainsBasic = "Plik zawiera tylko podstawowe dane formularza (Nazwa, Zawodnicy).";
translations.pl.loadFormData = "Wczytaj tylko dane formularza";
translations.pl.loadingTournament = "Wczytywanie turnieju";
translations.pl.noName = "Brak nazwy";
translations.pl.load = "Wczytaj";
translations.pl.expand = "Rozwi";
translations.pl.noMatches = "Brak mecz贸w do wywietlenia.";
translations.pl.played = "Rozegrany";
translations.pl.waiting = "Oczekuje";
translations.pl.quarterfinals = "wierfinay";
translations.pl.semifinals = "P贸finay"; 
translations.pl.final = "Fina";
translations.pl.thirdPlace = "Mecz o 3. miejsce";
translations.pl.fifthPlace = "Mecz o 5. miejsce";
translations.pl.seventhPlace = "Mecz o 7. miejsce";
translations.pl.consolationSemifinals = "P贸finay Pocieszenia";
translations.pl.finalClassification = "Klasyfikacja Kocowa";
translations.pl.consolationClassification = "Klasyfikacja (miejsca 5-8)";
translations.pl.group = "Grupa";
translations.pl.groups = "Grupy";
translations.pl.groupStage = "Faza grupowa";
translations.pl.selectDataToClear = "Wybierz dane do usunicia";
translations.pl.clearAutoMode = "Tryb AUTOMATYCZNY (grupy, wyniki, drabinka)";
translations.pl.clearManualMode = "Tryb RCZNY (grupy, wyniki, drabinka)";
translations.pl.clearEverything = "Wyczy WSZYSTKO (oba tryby)";
translations.pl.clearSelected = "Wyczy wybrane";
translations.pl.confirmClearAll = "Czy na pewno chcesz usun WSZYSTKIE dane turniejowe (oba tryby)? Spowoduje to usunicie grup, wynik贸w i drabinki pucharowej dla obu tryb贸w.";
translations.pl.confirmClearSelected = "Czy na pewno chcesz usun dane dla tryb贸w: ";
translations.pl.noOptionSelected = "Nie wybrano 偶adnej opcji do czyszczenia.";
translations.pl.allDataCleared = "Wszystkie dane turniejowe zostay usunite.";
translations.pl.dataCleared = "Dane zostay usunite: ";
translations.pl.clearError = "Bd podczas czyszczenia danych.";
translations.pl.and = "i";
translations.pl.selectExportMode = "Wybierz tryb do eksportu";
translations.pl.currentMode = "AKTUALNY TRYB";
translations.pl.bothModes = "OBA TRYBY";
translations.pl.export = "Eksportuj";
translations.pl.cancel = "Anuluj";
translations.pl.selectMode = "Nie wybrano tryb do eksportu.";
translations.pl.generateGroups = "Generuj tabele grupowe ";
translations.pl.generateBracket = "Generuj drabink pucharow ";
translations.pl.generateConsolation = "Generuj drabink pocieszenia ";


translations.en.enterPlayersFirst = "Enter players before generating groups!";
translations.en.invalidScore = "Score must be a number!";
translations.en.invalidScoreFormat = "Invalid score format! Use format '3:2'";
translations.en.noQualifiedPlayers = "No qualified players for knockout stage.";
translations.en.tooManyPlayers = "Too many qualified players detected. Only the top 8 players will be selected for the knockout bracket.";
translations.en.enableConsolationFirst = "To generate consolation bracket, check the 'Play Consolation Tournament' option in settings.";
translations.en.notEnoughLosers = "Not enough quarterfinal losers (need 4) to generate Consolation Tournament.";
translations.en.saveError = "Error saving data.";
translations.en.loadError = "Error loading file.";
translations.en.saveSuccess = "File saved: ";
translations.en.confirmClear = "Are you sure you want to clear all tournament data?";
translations.en.clearSuccess = "All tournament data has been cleared.";
translations.en.noTournamentData = "The loaded file contains no tournament data.";
translations.en.loadSuccess = "Tournament successfully loaded!";
translations.en.winner = "WINNER";
translations.en.qualified = "Q";
translations.en.points = "Points";
translations.en.sets = "Sets";
translations.en.setBalance = "Set Balance (W:L)";
translations.en.place = "Place";
translations.en.places = "places";
translations.en.tournamentResults = "TOURNAMENT RESULTS";
translations.en.exportDate = "Export date";
translations.en.finalClassification = "Final Classification";
translations.en.noClassificationData = "No data to display final classification.";
translations.en.selectExportMode = "Select export mode";
translations.en.currentMode = "CURRENT MODE";
translations.en.export = "Export";
translations.en.cancel = "Cancel";
translations.en.exportSuccess = "Results exported to file";
translations.en.selectMode = "No mode selected for export.";
translations.en.fileContainsBoth = "File contains data for both modes. Select mode to load:";
translations.en.bothModes = "Both modes";
translations.en.autoModeOnly = "Auto mode only";
translations.en.manualModeOnly = "Manual mode only";
translations.en.fileContainsAuto = "File contains auto mode data and form data.";
translations.en.loadAuto = "Load auto mode";
translations.en.fileContainsManual = "File contains manual mode data and form data.";
translations.en.loadManual = "Load manual mode";
translations.en.fileContainsBasic = "File contains only basic form data (Name, Players).";
translations.en.loadFormData = "Load form data only";
translations.en.loadingTournament = "Loading tournament";
translations.en.noName = "No name";
translations.en.load = "Load";
translations.en.expand = "Expand";
translations.en.noMatches = "No matches to display.";
translations.en.played = "Played";
translations.en.waiting = "Waiting";
translations.en.quarterfinals = "Quarterfinals";
translations.en.semifinals = "Semifinals";
translations.en.final = "Final";
translations.en.thirdPlace = "3rd Place Match";
translations.en.fifthPlace = "5th Place Match"; 
translations.en.seventhPlace = "7th Place Match";
translations.en.consolationSemifinals = "Consolation Semifinals";
translations.en.finalClassification = "Final Classification";
translations.en.consolationClassification = "Classification (Places 5-8)";
translations.en.group = "Group"; 
translations.en.groups = "Groups";
translations.en.groupStage = "Group Stage";
translations.en.selectDataToClear = "Select data to clear";
translations.en.clearAutoMode = "AUTO mode (groups, results, bracket)";
translations.en.clearManualMode = "MANUAL mode (groups, results, bracket)";
translations.en.clearEverything = "Clear EVERYTHING (both modes)";
translations.en.clearSelected = "Clear selected";
translations.en.confirmClearAll = "Are you sure you want to delete ALL tournament data (both modes)? This will remove groups, results and knockout bracket for both modes.";
translations.en.confirmClearSelected = "Are you sure you want to delete data for modes: ";
translations.en.noOptionSelected = "No option selected for clearing.";
translations.en.allDataCleared = "All tournament data has been cleared.";
translations.en.dataCleared = "Data cleared: ";
translations.en.clearError = "Error clearing data.";
translations.en.and = "and";
translations.en.selectExportMode = "Select export mode";
translations.en.currentMode = "CURRENT MODE";
translations.en.bothModes = "BOTH MODES";
translations.en.export = "Export";
translations.en.cancel = "Cancel";
translations.en.selectMode = "No mode selected for export.";
translations.en.generateGroups = "Generate Group Tables ";
translations.en.generateBracket = "Generate Knockout Bracket ";
translations.en.generateConsolation = "Generate Consolation Bracket ";
// ================= PWA - SERVICE WORKER =================
if ('serviceWorker' in navigator) {
  window.addEventListener('load', function() {
    navigator.serviceWorker.register('./service-worker.js')
      .then(function(registration) {
        console.log('Service Worker zarejestrowany pomylnie:', registration.scope);
        
        // Sprawd藕 czy jest ju偶 zainstalowany jako PWA
        if (window.matchMedia('(display-mode: standalone)').matches) {
          console.log('Aplikacja dziaa w trybie standalone (zainstalowana jako PWA)');
          document.body.classList.add('pwa-mode');
        }
        
        // Sprawd藕 aktualizacje co godzin
        setInterval(() => {
          registration.update();
        }, 60 * 60 * 1000);
      })
      .catch(function(error) {
        console.log('Bd rejestracji Service Worker:', error);
      });
  });
}

// Detekcja instalacji PWA
window.addEventListener('appinstalled', (evt) => {
  console.log('Aplikacja zostaa zainstalowana jako PWA!');
  // Mo偶esz wysa analytics lub pokaza komunikat
  alert('Dzikujemy za zainstalowanie aplikacji Turniej TT!');
});

// Pokazuj przycisk instalacji kiedy warunki s spenione
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  // Zapobiegaj automatycznemu pokazywaniu promptu
  e.preventDefault();
  // Zapisz event do p贸藕niejszego u偶ycia
  deferredPrompt = e;
  
  // Poka偶 przycisk instalacji (opcjonalnie)
  showInstallButton();
});

function showInstallButton() {
  const installBtn = document.createElement('button');
  installBtn.id = 'installPWAButton';
  installBtn.innerHTML = ' Zainstaluj aplikacj';
  installBtn.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #3498db;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 25px;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    z-index: 9999;
    display: flex;
    align-items: center;
    gap: 8px;
    animation: slideIn 0.3s ease;
  `;
  
  installBtn.onclick = async () => {
    if (!deferredPrompt) return;
    
    // Poka偶 prompt instalacji
    deferredPrompt.prompt();
    
    // Poczekaj na decyzj u偶ytkownika
    const { outcome } = await deferredPrompt.userChoice;
    
    if (outcome === 'accepted') {
      console.log('U偶ytkownik zaakceptowa instalacj PWA');
    } else {
      console.log('U偶ytkownik odrzuci instalacj PWA');
    }
    
    deferredPrompt = null;
    installBtn.remove();
  };
  
  document.body.appendChild(installBtn);
  
  // Ukryj przycisk po 30 sekundach
  setTimeout(() => {
    if (document.getElementById('installPWAButton')) {
      installBtn.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => installBtn.remove(), 300);
    }
  }, 30000);
}

// Dodaj animacje CSS
const style = document.createElement('style');
style.textContent = `
 @keyframes slideIn {
    from {
      transform: translateY(-100px); /* Zmieniono z 100 na -100 */
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
  
  @keyframes slideOut {
    from {
      transform: translateY(0);
      opacity: 1;
    }
    to {
      transform: translateY(-100px); /* Zmieniono z 100 na -100 */
      opacity: 0;
    }
  }
  
  /* Styl dla trybu PWA */
  body.pwa-mode header {
    padding-top: env(safe-area-inset-top);
  }
`;
document.head.appendChild(style);

// Sprawd藕 poczenie sieciowe
window.addEventListener('online', () => {
  console.log('Poczenie sieciowe przywr贸cone');
  document.body.classList.remove('offline-mode');
});

window.addEventListener('offline', () => {
  console.log('Brak poczenia sieciowego');
  document.body.classList.add('offline-mode');
  
  // Poka偶 komunikat offline
  const offlineMsg = document.createElement('div');
  offlineMsg.id = 'offlineMessage';
  offlineMsg.innerHTML = '锔 Tryb offline - dane zapisywane lokalnie';
  offlineMsg.style.cssText = `
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: #f39c12;
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    z-index: 9998;
    font-weight: bold;
    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
  `;
  document.body.appendChild(offlineMsg);
  
  // Ukryj po 5 sekundach
  setTimeout(() => {
    if (document.getElementById('offlineMessage')) {
      offlineMsg.remove();
    }
  }, 5000);
});

// Wymu zapis danych przed zamkniciem (dla PWA)
window.addEventListener('beforeunload', () => {
  if (typeof saveState === 'function') {
    saveState();
  }
});
</script>
</body>
</html>
